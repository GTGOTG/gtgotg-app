<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTGOTG - "Got To Go On The Go"</title>
    <meta name="description" content="Find clean, safe, and accessible restrooms wherever you are. Real people reviewing restrooms to assist you in finding one that meets your needs.">
    
    <!-- Leaflet CSS for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
        }

        .logo-fallback {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 3px solid white;
        }

        .app-title {
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .app-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .main-content {
            margin-top: 120px;
            padding: 2rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .search-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .search-title {
            font-size: 2rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .search-subtitle {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .search-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .location-btn {
            background: #3b82f6;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .location-btn:hover {
            background: #2563eb;
        }

        .location-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .category-filters {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .category-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .category-btn:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .category-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .results-section {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .results-header {
            background: #f8fafc;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-count {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn:first-child {
            border-radius: 8px 0 0 8px;
        }

        .view-btn:last-child {
            border-radius: 0 8px 8px 0;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .content-container {
            display: flex;
            min-height: 600px;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 600px;
        }

        .business-grid {
            flex: 1;
            max-height: 600px;
            overflow-y: auto;
            padding: 1rem;
        }

        .business-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .business-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .business-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .business-info h3 {
            font-size: 1.2rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .business-address {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .business-distance {
            color: #059669;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .business-rating {
            text-align: right;
        }

        .rating-stars {
            color: #fbbf24;
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .rating-text {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .business-tags {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .business-tag {
            background: #e5e7eb;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #374151;
        }

        .business-tag.brand {
            background: #dbeafe;
            color: #1e40af;
        }

        .business-tag.truck-stop {
            background: #fef3c7;
            color: #d97706;
        }

        .business-actions {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .rate-btn {
            background: #10b981;
            color: white;
        }

        .rate-btn:hover {
            background: #059669;
        }

        .directions-btn {
            background: #3b82f6;
            color: white;
        }

        .directions-btn:hover {
            background: #2563eb;
        }

        .business-owner-cta {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .business-owner-cta p {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .business-owner-cta button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.3s ease;
        }

        .business-owner-cta button:hover {
            background: #5b21b6;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            font-size: 1.1rem;
        }

        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            border: 1px solid #fecaca;
        }

        .success {
            background: #f0fdf4;
            color: #16a34a;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            border: 1px solid #bbf7d0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .footer {
            background: #1f2937;
            color: white;
            padding: 3rem 2rem 2rem;
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .footer-text {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            color: #d1d5db;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .footer-link {
            color: #9ca3af;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-link:hover {
            color: white;
        }

        .footer-copyright {
            color: #6b7280;
            font-size: 0.9rem;
            border-top: 1px solid #374151;
            padding-top: 1rem;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                margin-top: 160px;
                padding: 1rem;
            }

            .search-controls {
                flex-direction: column;
            }

            .search-input {
                min-width: auto;
            }

            .content-container {
                flex-direction: column;
            }

            .business-grid {
                max-height: none;
            }

            .category-filters {
                justify-content: flex-start;
            }

            .footer-links {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="assets/gtgotg_logo_primary-BE-ZRW_Y.png" alt="GTGOTG Logo" class="logo" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="logo-fallback" style="display: none;">🚽</div>
                <div>
                    <div class="app-title">GTGOTG</div>
                    <div class="app-subtitle">"Got To Go On The Go"</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openLoginModal()">Login</button>
                <button class="btn btn-primary" onclick="openSignupModal()">Sign Up</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Search Section -->
        <section class="search-section">
            <div class="search-header">
                <h1 class="search-title">Find Clean, Safe Restrooms</h1>
                <p class="search-subtitle">Search by business name, city, state, or ZIP code - Now with comprehensive truck stop coverage!</p>
            </div>
            
            <div class="search-controls">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="Search McDonald's, Denver CO, Colorado, 80202, or any location...">
                <button class="location-btn" id="locationBtn" onclick="enableLocation()">
                    📍 Enable Location
                </button>
            </div>

            <div class="category-filters">
                <button class="category-btn active" onclick="filterByCategory('')">All</button>
                <button class="category-btn" onclick="filterByCategory('fuel')">Gas Stations</button>
                <button class="category-btn" onclick="filterByCategory('truck_stop')">Truck Stops</button>
                <button class="category-btn" onclick="filterByCategory('highway_services')">Highway Services</button>
                <button class="category-btn" onclick="filterByCategory('rest_area')">Rest Areas</button>
                <button class="category-btn" onclick="filterByCategory('fast_food')">Fast Food</button>
                <button class="category-btn" onclick="filterByCategory('restaurant')">Restaurants</button>
                <button class="category-btn" onclick="filterByCategory('cafe')">Coffee Shops</button>
                <button class="category-btn" onclick="filterByCategory('convenience')">Convenience</button>
                <button class="category-btn" onclick="filterByCategory('supermarket')">Supermarkets</button>
                <button class="category-btn" onclick="filterByCategory('hotel')">Hotels</button>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Ready to search</div>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('split')">Map + List</button>
                    <button class="view-btn" onclick="switchView('map')">Map Only</button>
                    <button class="view-btn" onclick="switchView('list')">List Only</button>
                </div>
            </div>
            
            <div class="content-container" id="contentContainer">
                <div class="map-container" id="mapContainer">
                    <div id="map"></div>
                </div>
                <div class="business-grid" id="businessGrid">
                    <div class="loading">Enter a search term or enable location to find restrooms near you</div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p class="footer-text">Real people reviewing restrooms to assist you in finding one that meets your needs, wherever you are</p>
            <div class="footer-links">
                <a href="#" class="footer-link" onclick="openModal('aboutModal')">About</a>
                <a href="#" class="footer-link" onclick="openModal('privacyModal')">Privacy Policy</a>
                <a href="#" class="footer-link" onclick="openModal('termsModal')">Terms of Service</a>
                <a href="#" class="footer-link" onclick="openModal('contactModal')">Contact</a>
                <a href="#" class="footer-link" onclick="openModal('helpModal')">Help</a>
            </div>
            <div class="footer-copyright">
                © 2025 Jessica Esposito / Colorado Quality LLC. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Login to GTGOTG</h2>
                <button class="close-btn" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Admin Dashboard</h2>
                <button class="close-btn" onclick="closeModal('adminModal')">&times;</button>
            </div>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button class="btn btn-primary" onclick="showAdminSection('users')">Manage Users</button>
                <button class="btn btn-primary" onclick="showAdminSection('businesses')">Manage Businesses</button>
                <button class="btn btn-primary" onclick="showAdminSection('reviews')">Moderate Reviews</button>
            </div>
            <div id="adminSectionContent">
                <p>Select a section to manage.</p>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript for OpenStreetMap -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Global variables
        let map;
        let userLocation = null;
        let currentUser = null;
        let businesses = [];
        let markers = [];
        let currentCategory = '';
        let currentView = 'split';
        let searchAttempts = 0;

        // Admin credentials
        const ADMIN_CREDENTIALS = {
            username: 'Adminjess',
            password: 'Alainajade1!'
        };

        // US State bounding boxes for comprehensive searches
        const US_STATE_BOUNDS = {
            'colorado': [36.9929, -109.0452, 41.0023, -102.0415],
            'california': [32.5343, -124.4096, 42.0095, -114.1312],
            'texas': [25.8371, -106.6456, 36.5007, -93.5083],
            'florida': [24.3963, -87.6349, 31.0009, -79.9743],
            'new york': [40.4774, -79.7624, 45.0153, -71.7774],
            'illinois': [36.9703, -91.5130, 42.5083, -87.0199],
            'pennsylvania': [39.7198, -80.5190, 42.2694, -74.6895],
            'ohio': [38.4031, -84.8203, 41.9773, -80.5190],
            'georgia': [30.3557, -85.6051, 35.0008, -80.8414],
            'north carolina': [33.7514, -84.3218, 36.5881, -75.4001],
            'michigan': [41.6960, -90.4181, 48.2388, -82.1220],
            'new jersey': [38.9284, -75.5594, 41.3574, -73.8937],
            'virginia': [36.5407, -83.6753, 39.4660, -75.2420],
            'washington': [45.5435, -124.8489, 49.0024, -116.9155],
            'arizona': [31.3322, -114.8165, 37.0043, -109.0452],
            'massachusetts': [41.2376, -73.5081, 42.8868, -69.9286],
            'tennessee': [34.9829, -90.3103, 36.6782, -81.6469],
            'indiana': [37.7554, -88.0157, 41.7606, -84.7845],
            'missouri': [35.9957, -95.7742, 40.6136, -89.0993],
            'maryland': [37.9118, -79.4877, 39.7238, -75.0490],
            'wisconsin': [42.4919, -92.8892, 47.0803, -86.2490],
            'minnesota': [43.4993, -97.2394, 49.3844, -89.4836],
            'louisiana': [28.9285, -94.0431, 33.0197, -88.8175],
            'alabama': [30.2226, -88.4731, 35.0081, -84.8890],
            'kentucky': [36.4970, -89.5715, 39.1472, -81.9649],
            'oregon': [41.9918, -124.7035, 46.2991, -116.4635],
            'oklahoma': [33.6160, -103.0025, 37.0020, -94.4312],
            'connecticut': [40.9509, -73.7277, 42.0508, -71.7869],
            'utah': [36.9979, -114.0524, 42.0013, -109.0452],
            'iowa': [40.3756, -96.6397, 43.5012, -90.1401],
            'nevada': [35.0018, -120.0064, 42.0022, -114.0396],
            'arkansas': [33.0041, -94.6178, 36.4996, -89.6444],
            'mississippi': [30.1734, -91.6550, 34.9961, -88.0977],
            'kansas': [36.9930, -102.0517, 40.0030, -94.5882],
            'new mexico': [31.3323, -109.0501, 37.0002, -103.0020],
            'nebraska': [39.9999, -104.0537, 43.0017, -95.3080],
            'west virginia': [37.2014, -82.6447, 40.6381, -77.7190],
            'idaho': [41.9880, -117.2430, 49.0011, -111.0435],
            'hawaii': [18.9117, -178.4348, 28.4025, -154.8056],
            'new hampshire': [42.6970, -72.5570, 45.3058, -70.6104],
            'maine': [43.0642, -71.0840, 47.4598, -66.9851],
            'montana': [44.3583, -116.0489, 49.0011, -104.0395],
            'rhode island': [41.1460, -71.8620, 42.0188, -71.1208],
            'delaware': [38.4511, -75.7890, 39.8394, -75.0490],
            'south dakota': [42.4798, -104.0578, 45.9454, -96.4364],
            'north dakota': [45.9350, -104.0489, 49.0011, -96.5544],
            'alaska': [51.2097, -179.1506, 71.4410, -129.9795],
            'vermont': [42.7269, -73.4544, 45.0167, -71.4653],
            'wyoming': [40.9979, -111.0567, 45.0018, -104.0522]
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚽 GTGOTG - "Got To Go On The Go" - Enhanced Truck Stop Search Initializing...');
            initializeMap();
            setupEventListeners();
            console.log('✅ GTGOTG - Enhanced application initialized successfully!');
        });

        // Initialize the map
        function initializeMap() {
            try {
                // Initialize map centered on Denver, CO
                map = L.map('map').setView([39.7392, -104.9903], 6);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                console.log('✅ Map initialized successfully');
            } catch (error) {
                console.error('❌ Error initializing map:', error);
                document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; color: #6b7280;">Map temporarily unavailable. Please try refreshing the page.</div>';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            
            // Search on Enter key
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Search as user types (debounced)
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (searchInput.value.length >= 3) {
                        performSearch();
                    }
                }, 1000);
            });
        }

        // Perform search with improved logic
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query && !userLocation) {
                showError('Please enter a search term or enable location');
                return;
            }

            // Parse the search query to separate business name from location
            const parsedQuery = parseSearchQuery(query);
            console.log('🔍 Parsed search query:', parsedQuery);

            await searchBusinesses(parsedQuery, userLocation?.lat, userLocation?.lng, currentCategory);
        }

        // Parse search query to separate business name from location
        function parseSearchQuery(query) {
            if (!query) return { businessName: '', location: '', original: '' };

            // Common patterns to identify business names vs locations
            const businessKeywords = ['mcdonalds', 'mcdonald', 'shell', 'exxon', 'bp', 'starbucks', 'subway', 'walmart', 'target', 'chevron', 'mobil', 'texaco', 'burger king', 'taco bell', 'kfc', 'pizza hut', 'dominos', 'papa johns', 'pilot', 'flying j', 'loves', 'ta', 'petro'];
            const locationKeywords = ['co', 'colorado', 'ca', 'california', 'tx', 'texas', 'ny', 'new york', 'fl', 'florida', 'denver', 'los angeles', 'houston', 'chicago', 'phoenix'];

            const words = query.toLowerCase().split(/[\s,]+/);
            let businessName = '';
            let location = '';

            // Try to identify business name
            for (const keyword of businessKeywords) {
                if (words.some(word => word.includes(keyword))) {
                    businessName = keyword === 'mcdonald' ? 'McDonald\'s' : 
                                  keyword === 'mcdonalds' ? 'McDonald\'s' :
                                  keyword.charAt(0).toUpperCase() + keyword.slice(1);
                    break;
                }
            }

            // If we found a business name, the rest is likely location
            if (businessName) {
                const businessWords = businessName.toLowerCase().split(/[\s']+/);
                const locationWords = words.filter(word => 
                    !businessWords.some(bw => word.includes(bw.replace(/[^a-z]/g, '')))
                );
                location = locationWords.join(' ');
            } else {
                // Check if it looks like a location (contains state abbreviations, city names, or ZIP codes)
                const zipCodePattern = /\b\d{5}\b/;
                const hasZip = zipCodePattern.test(query);
                const hasLocationKeyword = locationKeywords.some(keyword => 
                    words.some(word => word.includes(keyword))
                );

                if (hasZip || hasLocationKeyword || words.length <= 3) {
                    location = query;
                } else {
                    // Assume it's a business name if it doesn't look like a location
                    businessName = query;
                }
            }

            return {
                businessName: businessName.trim(),
                location: location.trim(),
                original: query
            };
        }

        // Enhanced search function with comprehensive truck stop coverage
        async function searchBusinesses(parsedQuery, userLat = null, userLng = null, category = '') {
            try {
                console.log('🔍 Enhanced search for businesses:', parsedQuery, 'Category:', category, 'Location:', userLat, userLng);
                
                // Show loading state
                document.getElementById('businessGrid').innerHTML = '<div class="loading">🔍 Searching for businesses nationwide...</div>';
                document.getElementById('resultsCount').textContent = 'Searching...';

                let searchBounds = null;
                let searchCenter = null;

                // Determine search area
                if (userLat && userLng) {
                    searchCenter = { lat: userLat, lng: userLng };
                    searchBounds = calculateBounds(userLat, userLng, 50000); // 50km radius
                } else if (parsedQuery.location) {
                    // Try to get state bounds first, then geocode
                    searchBounds = getStateBounds(parsedQuery.location);
                    if (!searchBounds) {
                        searchCenter = await geocodeLocation(parsedQuery.location);
                        if (searchCenter) {
                            searchBounds = calculateBounds(searchCenter.lat, searchCenter.lng, 100000); // 100km radius
                            map.setView([searchCenter.lat, searchCenter.lng], 8);
                        }
                    } else {
                        // Center map on state
                        const centerLat = (searchBounds[0] + searchBounds[2]) / 2;
                        const centerLng = (searchBounds[1] + searchBounds[3]) / 2;
                        map.setView([centerLat, centerLng], 7);
                    }
                }

                // Try multiple comprehensive search strategies
                let results = [];
                searchAttempts = 0;

                // Strategy 1: Comprehensive highway facilities search
                if (searchBounds) {
                    results = await trySearch(() => buildComprehensiveHighwayQuery(searchBounds, category, parsedQuery.businessName));
                }

                // Strategy 2: Truck-specific search if looking for truck stops
                if (results.length < 10 && (category === 'truck_stop' || category === 'highway_services' || !category)) {
                    results = results.concat(await trySearch(() => buildTruckSpecificQuery(searchBounds, parsedQuery.businessName)));
                }

                // Strategy 3: State-wide search for major chains
                if (results.length < 5 && parsedQuery.businessName && searchBounds) {
                    results = results.concat(await trySearch(() => buildChainSearchQuery(searchBounds, parsedQuery.businessName)));
                }

                // Strategy 4: Fallback to sample data if needed
                if (results.length === 0) {
                    console.log('🔄 Using enhanced sample data with truck stops');
                    results = generateEnhancedSampleBusinesses(searchCenter, parsedQuery.location);
                }

                // Remove duplicates and limit results
                const uniqueResults = removeDuplicateBusinesses(results);
                businesses = uniqueResults.slice(0, 200); // Increased limit for better coverage
                
                renderBusinesses();
                addMarkersToMap();
                updateResultsCount();

                console.log(`✅ Found ${businesses.length} businesses (${uniqueResults.length} unique from ${results.length} total)`);

            } catch (error) {
                console.error('❌ Error searching businesses:', error);
                handleSearchError(error);
            }
        }

        // Get state bounding box
        function getStateBounds(location) {
            const locationLower = location.toLowerCase();
            
            // Check for state names or abbreviations
            for (const [state, bounds] of Object.entries(US_STATE_BOUNDS)) {
                if (locationLower.includes(state) || 
                    locationLower.includes(state.replace(' ', '')) ||
                    (state === 'colorado' && locationLower.includes('co')) ||
                    (state === 'california' && locationLower.includes('ca')) ||
                    (state === 'texas' && locationLower.includes('tx')) ||
                    (state === 'florida' && locationLower.includes('fl')) ||
                    (state === 'new york' && locationLower.includes('ny'))) {
                    return bounds;
                }
            }
            return null;
        }

        // Calculate bounding box from center point and radius
        function calculateBounds(lat, lng, radiusMeters) {
            const latDelta = radiusMeters / 111000; // Approximate meters per degree latitude
            const lngDelta = radiusMeters / (111000 * Math.cos(lat * Math.PI / 180));
            
            return [
                lat - latDelta,  // south
                lng - lngDelta,  // west
                lat + latDelta,  // north
                lng + lngDelta   // east
            ];
        }

        // Build comprehensive highway facilities query
        function buildComprehensiveHighwayQuery(bounds, category, businessName) {
            const bbox = `(bbox:${bounds[0]},${bounds[1]},${bounds[2]},${bounds[3]})`;
            
            let queries = [];
            
            if (category === 'truck_stop' || category === 'highway_services' || !category) {
                // Highway service areas (travel plazas, truck stops)
                queries.push(`nwr["highway"="services"]${bbox};`);
                
                // Truck-accessible fuel stations
                queries.push(`nwr["amenity"="fuel"]["hgv"="yes"]${bbox};`);
                queries.push(`nwr["amenity"="fuel"]["truck"="yes"]${bbox};`);
                
                // Large fuel stations with truck capacity
                queries.push(`nwr["amenity"="fuel"]["capacity:hgv"]${bbox};`);
            }
            
            if (category === 'rest_area' || !category) {
                // Rest areas
                queries.push(`nwr["highway"="rest_area"]${bbox};`);
            }
            
            if (category === 'fuel' || !category) {
                // All fuel stations
                queries.push(`nwr["amenity"="fuel"]${bbox};`);
            }
            
            if (!category || ['fast_food', 'restaurant', 'cafe', 'convenience', 'supermarket', 'hotel'].includes(category)) {
                // Other business types
                const categoryMap = {
                    'fast_food': 'nwr["amenity"="fast_food"]',
                    'restaurant': 'nwr["amenity"="restaurant"]',
                    'cafe': 'nwr["amenity"="cafe"]',
                    'convenience': 'nwr["shop"="convenience"]',
                    'supermarket': 'nwr["shop"="supermarket"]',
                    'hotel': 'nwr["tourism"="hotel"]'
                };
                
                if (category && categoryMap[category]) {
                    queries.push(`${categoryMap[category]}${bbox};`);
                } else if (!category) {
                    // Include all major categories
                    queries.push(`nwr["amenity"~"^(restaurant|fast_food|cafe)$"]${bbox};`);
                    queries.push(`nwr["shop"~"^(convenience|supermarket)$"]${bbox};`);
                    queries.push(`nwr["tourism"="hotel"]${bbox};`);
                }
            }
            
            // Add business name filter if specified
            if (businessName) {
                const escapedName = businessName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                queries = queries.map(query => query.replace(bbox, `["name"~"${escapedName}",i]${bbox}`));
            }
            
            return `
                [out:json][timeout:20];
                (
                  ${queries.join('\n  ')}
                );
                out center meta 300;
            `;
        }

        // Build truck-specific query
        function buildTruckSpecificQuery(bounds, businessName) {
            const bbox = bounds ? `(bbox:${bounds[0]},${bounds[1]},${bounds[2]},${bounds[3]})` : '';
            const nameFilter = businessName ? `["name"~"${businessName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}",i]` : '';
            
            return `
                [out:json][timeout:20];
                (
                  // Major truck stop chains
                  nwr["amenity"="fuel"]["brand"~"Pilot|Flying.J|Love.s|TA|Petro|Speedway",i]${nameFilter}${bbox};
                  
                  // Highway services with truck facilities
                  nwr["highway"="services"]["hgv"="yes"]${nameFilter}${bbox};
                  
                  // Fuel stations with truck access
                  nwr["amenity"="fuel"]["hgv"="yes"]${nameFilter}${bbox};
                  nwr["amenity"="fuel"]["truck"="yes"]${nameFilter}${bbox};
                  
                  // Large capacity fuel stations
                  nwr["amenity"="fuel"]["capacity:hgv"]${nameFilter}${bbox};
                  
                  // Commercial areas near highways (may contain truck stops)
                  nwr["landuse"="commercial"]["highway"]${bbox};
                );
                out center meta 200;
            `;
        }

        // Build chain search query
        function buildChainSearchQuery(bounds, businessName) {
            const bbox = bounds ? `(bbox:${bounds[0]},${bounds[1]},${bounds[2]},${bounds[3]})` : '';
            const escapedName = businessName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            return `
                [out:json][timeout:20];
                (
                  // Search by name across all amenity types
                  nwr["name"~"${escapedName}",i]${bbox};
                  
                  // Search by brand
                  nwr["brand"~"${escapedName}",i]${bbox};
                  
                  // Search by operator
                  nwr["operator"~"${escapedName}",i]${bbox};
                );
                out center meta 150;
            `;
        }

        // Try a search with error handling and retries
        async function trySearch(queryBuilder, maxRetries = 2) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    searchAttempts++;
                    const query = queryBuilder();
                    console.log(`📡 Enhanced search attempt ${searchAttempts}:`, query.substring(0, 200) + '...');

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 second timeout

                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `data=${encodeURIComponent(query)}`,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const processedResults = processOverpassResults(data.elements, null, null);
                    
                    console.log(`📊 Search attempt ${searchAttempts} returned ${processedResults.length} results`);
                    return processedResults;
                    
                } catch (error) {
                    console.warn(`⚠️ Search attempt ${attempt + 1} failed:`, error.message);
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            return [];
        }

        // Generate enhanced sample businesses with truck stops
        function generateEnhancedSampleBusinesses(searchCenter, location) {
            const sampleBusinesses = [
                // Truck stops and highway services
                { name: 'Pilot Travel Center', category: 'truck_stop', brand: 'Pilot', isTruckStop: true },
                { name: 'Flying J Travel Plaza', category: 'truck_stop', brand: 'Flying J', isTruckStop: true },
                { name: 'Love\'s Travel Stop', category: 'truck_stop', brand: 'Love\'s', isTruckStop: true },
                { name: 'TA Travel Center', category: 'truck_stop', brand: 'TA', isTruckStop: true },
                { name: 'Petro Stopping Center', category: 'truck_stop', brand: 'Petro', isTruckStop: true },
                { name: 'Speedway Travel Plaza', category: 'truck_stop', brand: 'Speedway', isTruckStop: true },
                
                // Highway rest areas
                { name: 'Interstate Rest Area - Mile 45', category: 'rest_area', brand: '', isRestArea: true },
                { name: 'Highway Welcome Center', category: 'rest_area', brand: '', isRestArea: true },
                { name: 'State Line Rest Stop', category: 'rest_area', brand: '', isRestArea: true },
                
                // Gas stations
                { name: 'Shell Gas Station', category: 'fuel', brand: 'Shell' },
                { name: 'Chevron', category: 'fuel', brand: 'Chevron' },
                { name: 'Exxon Mobil', category: 'fuel', brand: 'Exxon' },
                { name: 'BP Gas Station', category: 'fuel', brand: 'BP' },
                
                // Fast food
                { name: 'McDonald\'s', category: 'fast_food', brand: 'McDonald\'s' },
                { name: 'Subway', category: 'fast_food', brand: 'Subway' },
                { name: 'Burger King', category: 'fast_food', brand: 'Burger King' },
                { name: 'Taco Bell', category: 'fast_food', brand: 'Taco Bell' },
                
                // Coffee and convenience
                { name: 'Starbucks', category: 'cafe', brand: 'Starbucks' },
                { name: '7-Eleven', category: 'convenience', brand: '7-Eleven' },
                { name: 'Circle K', category: 'convenience', brand: 'Circle K' },
                
                // Supermarkets and hotels
                { name: 'Walmart Supercenter', category: 'supermarket', brand: 'Walmart' },
                { name: 'Target', category: 'supermarket', brand: 'Target' },
                { name: 'Holiday Inn Express', category: 'hotel', brand: 'Holiday Inn' },
                { name: 'Hampton Inn', category: 'hotel', brand: 'Hampton Inn' }
            ];

            const baseLat = searchCenter ? searchCenter.lat : 39.7392;
            const baseLng = searchCenter ? searchCenter.lng : -104.9903;
            const locationName = location || 'Denver, CO';

            return sampleBusinesses.map((business, index) => ({
                id: `sample_${index}`,
                name: business.name,
                address: `${1000 + index * 100} Highway Blvd, ${locationName}`,
                lat: baseLat + (Math.random() - 0.5) * 2, // Spread over larger area
                lng: baseLng + (Math.random() - 0.5) * 2,
                category: business.category,
                brand: business.brand,
                phone: `(555) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
                website: business.brand ? `https://www.${business.brand.toLowerCase().replace(/[^a-z]/g, '')}.com` : '',
                opening_hours: business.isTruckStop ? '24/7' : business.isRestArea ? 'Always Open' : 'Mon-Sun 6:00-22:00',
                distance: searchCenter ? Math.random() * 50 + 1 : null,
                rating: generateRandomRating(),
                amenities: generateEnhancedAmenities(business),
                isTruckStop: business.isTruckStop || false,
                isRestArea: business.isRestArea || false
            }));
        }

        // Generate enhanced amenities based on business type
        function generateEnhancedAmenities(business) {
            const amenities = [];
            
            // Common amenities
            if (Math.random() > 0.3) amenities.push('🚻 Family Restroom');
            if (Math.random() > 0.4) amenities.push('♿ ADA Accessible');
            if (Math.random() > 0.5) amenities.push('🧻 Paper Towels');
            if (Math.random() > 0.6) amenities.push('🧼 Soap Dispenser');
            
            // Truck stop specific amenities
            if (business.isTruckStop) {
                amenities.push('🚛 Truck Parking');
                amenities.push('⛽ Diesel Fuel');
                if (Math.random() > 0.3) amenities.push('🚿 Shower Facilities');
                if (Math.random() > 0.4) amenities.push('🍔 Food Court');
                if (Math.random() > 0.5) amenities.push('🛒 Convenience Store');
                if (Math.random() > 0.6) amenities.push('🔧 Truck Repair');
                if (Math.random() > 0.7) amenities.push('📺 Driver Lounge');
                if (Math.random() > 0.8) amenities.push('🧺 Laundry');
            }
            
            // Rest area amenities
            if (business.isRestArea) {
                amenities.push('🅿️ Free Parking');
                amenities.push('🗑️ Waste Disposal');
                if (Math.random() > 0.4) amenities.push('🏓 Picnic Tables');
                if (Math.random() > 0.5) amenities.push('🐕 Pet Area');
                if (Math.random() > 0.6) amenities.push('💧 Water Fountain');
                if (Math.random() > 0.7) amenities.push('📍 Tourist Information');
            }
            
            // Gas station amenities
            if (business.category === 'fuel') {
                if (Math.random() > 0.4) amenities.push('🚗 Car Wash');
                if (Math.random() > 0.6) amenities.push('🛒 Convenience Store');
                if (Math.random() > 0.7) amenities.push('☕ Coffee');
            }
            
            return amenities;
        }

        // Remove duplicate businesses
        function removeDuplicateBusinesses(businesses) {
            const seen = new Set();
            return businesses.filter(business => {
                const key = `${business.name}_${business.lat.toFixed(3)}_${business.lng.toFixed(3)}`;
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }

        // Process Overpass API results with enhanced categorization
        function processOverpassResults(elements, userLat, userLng) {
            const processedBusinesses = [];
            const seenBusinesses = new Set();

            elements.forEach((element) => {
                if (!element.tags) return;

                // Allow businesses without names for highway services and rest areas
                const name = element.tags.name || generateDefaultName(element.tags);
                if (!name) return;

                let lat, lng;
                if (element.type === 'node') {
                    lat = element.lat;
                    lng = element.lon;
                } else if (element.center) {
                    lat = element.center.lat;
                    lng = element.center.lon;
                } else {
                    return;
                }

                const uniqueId = `${name}_${lat.toFixed(4)}_${lng.toFixed(4)}`;
                if (seenBusinesses.has(uniqueId)) return;
                seenBusinesses.add(uniqueId);

                let category = determineEnhancedBusinessCategory(element.tags);
                let address = buildAddress(element.tags);
                let distance = null;
                if (userLat && userLng) {
                    distance = calculateDistance(userLat, userLng, lat, lng);
                }

                const business = {
                    id: `osm_${element.type}_${element.id}`,
                    name: name,
                    address: address,
                    lat: lat,
                    lng: lng,
                    category: category,
                    brand: element.tags.brand || element.tags.operator || '',
                    phone: element.tags.phone || '',
                    website: element.tags.website || '',
                    opening_hours: element.tags.opening_hours || 'Hours not available',
                    distance: distance,
                    rating: generateRandomRating(),
                    amenities: generateEnhancedAmenities({
                        category: category,
                        isTruckStop: isEnhancedTruckStop(element.tags),
                        isRestArea: element.tags.highway === 'rest_area'
                    }),
                    isTruckStop: isEnhancedTruckStop(element.tags),
                    isRestArea: element.tags.highway === 'rest_area'
                };

                processedBusinesses.push(business);
            });

            // Sort by distance if available, otherwise by name
            if (userLat && userLng) {
                processedBusinesses.sort((a, b) => (a.distance || 999) - (b.distance || 999));
            } else {
                processedBusinesses.sort((a, b) => a.name.localeCompare(b.name));
            }

            return processedBusinesses;
        }

        // Generate default name for unnamed facilities
        function generateDefaultName(tags) {
            if (tags.highway === 'services') {
                return tags.operator ? `${tags.operator} Travel Center` : 'Highway Service Area';
            } else if (tags.highway === 'rest_area') {
                return 'Highway Rest Area';
            } else if (tags.amenity === 'fuel' && (tags.hgv === 'yes' || tags.truck === 'yes')) {
                return tags.brand ? `${tags.brand} Truck Stop` : 'Truck Stop';
            }
            return null;
        }

        // Enhanced business category determination
        function determineEnhancedBusinessCategory(tags) {
            // Highway facilities
            if (tags.highway === 'services') {
                return 'highway_services';
            } else if (tags.highway === 'rest_area') {
                return 'rest_area';
            }
            
            // Truck stops
            if (tags.amenity === 'fuel' && (tags.hgv === 'yes' || tags.truck === 'yes' || tags['capacity:hgv'])) {
                return 'truck_stop';
            }
            
            // Regular categories
            if (tags.amenity === 'fuel') {
                return 'fuel';
            } else if (tags.amenity === 'fast_food') {
                return 'fast_food';
            } else if (tags.amenity === 'restaurant') {
                return 'restaurant';
            } else if (tags.amenity === 'cafe') {
                return 'cafe';
            } else if (tags.shop === 'convenience') {
                return 'convenience';
            } else if (tags.shop === 'supermarket') {
                return 'supermarket';
            } else if (tags.tourism === 'hotel') {
                return 'hotel';
            } else if (tags.leisure === 'park') {
                return 'park';
            }
            return 'other';
        }

        // Check if facility is a truck stop
        function isEnhancedTruckStop(tags) {
            return tags.highway === 'services' ||
                   (tags.amenity === 'fuel' && (tags.hgv === 'yes' || tags.truck === 'yes' || tags['capacity:hgv'])) ||
                   (tags.brand && ['pilot', 'flying j', 'loves', 'ta', 'petro', 'speedway'].some(brand => 
                       tags.brand.toLowerCase().includes(brand)));
        }

        // Geocode location using Nominatim
        async function geocodeLocation(query) {
            try {
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&limit=1`;
                const response = await fetch(nominatimUrl);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('❌ Geocoding error:', error);
                return null;
            }
        }

        // Build address from OSM tags
        function buildAddress(tags) {
            let address = '';
            if (tags['addr:housenumber'] && tags['addr:street']) {
                address += `${tags['addr:housenumber']} ${tags['addr:street']}, `;
            }
            if (tags['addr:city']) {
                address += `${tags['addr:city']}, `;
            }
            if (tags['addr:state']) {
                address += `${tags['addr:state']} `;
            }
            if (tags['addr:postcode']) {
                address += tags['addr:postcode'];
            }

            return address.trim() || 'Address not available';
        }

        // Generate placeholder rating
        function generateRandomRating() {
            return {
                overall: Math.floor(Math.random() * 4) + 7,
                cleanliness: Math.floor(Math.random() * 4) + 6,
                safety: Math.floor(Math.random() * 4) + 7,
                accessibility: Math.floor(Math.random() * 4) + 6,
                reviewCount: Math.floor(Math.random() * 50) + 5
            };
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Render businesses in the grid
        function renderBusinesses() {
            const grid = document.getElementById('businessGrid');
            
            if (businesses.length === 0) {
                grid.innerHTML = '<div class="loading">No businesses found. Try a different search term or location.</div>';
                return;
            }

            grid.innerHTML = businesses.map(business => `
                <div class="business-card" onclick="openBusinessDetails('${business.id}')">
                    <div class="business-header">
                        <div class="business-info">
                            <h3>${business.name}</h3>
                            <div class="business-address">${business.address}</div>
                            ${business.distance ? `<div class="business-distance">${business.distance.toFixed(1)} miles away</div>` : ''}
                        </div>
                        <div class="business-rating">
                            <div class="rating-stars">${'⭐'.repeat(Math.floor(business.rating.overall / 2))}</div>
                            <div class="rating-text">${business.rating.overall}/10 (${business.rating.reviewCount} reviews)</div>
                        </div>
                    </div>
                    
                    <div class="business-tags">
                        <span class="business-tag ${business.isTruckStop ? 'truck-stop' : ''}">${formatEnhancedCategory(business.category)}</span>
                        ${business.brand ? `<span class="business-tag brand">${business.brand}</span>` : ''}
                        ${business.isTruckStop ? '<span class="business-tag truck-stop">🚛 Truck Stop</span>' : ''}
                        ${business.isRestArea ? '<span class="business-tag">🛣️ Rest Area</span>' : ''}
                    </div>
                    
                    <div style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                        ${business.opening_hours}
                    </div>
                    
                    ${business.amenities.length > 0 ? `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem;">Amenities:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; font-size: 0.75rem;">
                            ${business.amenities.slice(0, 6).map(amenity => `<span style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px;">${amenity}</span>`).join('')}
                            ${business.amenities.length > 6 ? `<span style="color: #6b7280;">+${business.amenities.length - 6} more</span>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="business-actions">
                        <button class="action-btn rate-btn" onclick="event.stopPropagation(); openRatingModal('${business.id}')">
                            Rate Restroom
                        </button>
                        <button class="action-btn directions-btn" onclick="event.stopPropagation(); getDirections(${business.lat}, ${business.lng})">
                            Directions
                        </button>
                    </div>
                    
                    <div class="business-owner-cta">
                        <p>Business Owner?</p>
                        <button onclick="event.stopPropagation(); openBusinessOwnerSignup()">Claim This Listing</button>
                    </div>
                </div>
            `).join('');
        }

        // Format enhanced category names
        function formatEnhancedCategory(category) {
            const categoryMap = {
                'fuel': 'Gas Station',
                'truck_stop': 'Truck Stop',
                'highway_services': 'Highway Services',
                'rest_area': 'Rest Area',
                'fast_food': 'Fast Food',
                'restaurant': 'Restaurant',
                'cafe': 'Coffee Shop',
                'convenience': 'Convenience Store',
                'supermarket': 'Supermarket',
                'hotel': 'Hotel',
                'park': 'Park',
                'other': 'Business'
            };
            return categoryMap[category] || 'Business';
        }

        // Add markers to map
        function addMarkersToMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (businesses.length === 0) return;

            businesses.forEach(business => {
                // Use different icons for different business types
                let iconColor = '#3b82f6';
                let iconSymbol = '📍';
                
                if (business.isTruckStop) {
                    iconColor = '#d97706';
                    iconSymbol = '🚛';
                } else if (business.isRestArea) {
                    iconColor = '#059669';
                    iconSymbol = '🛣️';
                } else if (business.category === 'fuel') {
                    iconColor = '#dc2626';
                    iconSymbol = '⛽';
                }

                const marker = L.marker([business.lat, business.lng])
                    .addTo(map)
                    .bindPopup(`
                        <div style="text-align: center;">
                            <h3>${business.name}</h3>
                            <p>${business.address}</p>
                            <p><strong>${formatEnhancedCategory(business.category)}</strong></p>
                            ${business.isTruckStop ? '<p style="color: #d97706;">🚛 Truck Stop</p>' : ''}
                            ${business.isRestArea ? '<p style="color: #059669;">🛣️ Rest Area</p>' : ''}
                            <p>⭐ ${business.rating.overall}/10 (${business.rating.reviewCount} reviews)</p>
                            <button onclick="getDirections(${business.lat}, ${business.lng})" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-top: 0.5rem;">Get Directions</button>
                        </div>
                    `);
                
                markers.push(marker);
            });

            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Update results count
        function updateResultsCount() {
            const count = businesses.length;
            const truckStops = businesses.filter(b => b.isTruckStop).length;
            const restAreas = businesses.filter(b => b.isRestArea).length;
            
            let countText = count === 0 ? 'No results found' : 
                           count === 1 ? '1 business found' : 
                           `${count} businesses found`;
            
            if (truckStops > 0 || restAreas > 0) {
                const details = [];
                if (truckStops > 0) details.push(`${truckStops} truck stops`);
                if (restAreas > 0) details.push(`${restAreas} rest areas`);
                countText += ` (${details.join(', ')})`;
            }
            
            document.getElementById('resultsCount').textContent = countText;
        }

        // Handle search errors
        function handleSearchError(error) {
            let errorMessage = 'Unable to search businesses. ';
            
            if (error.name === 'AbortError') {
                errorMessage += 'Search timed out. Please try a more specific search term.';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage += 'Network connection issue. Please check your internet connection.';
            } else {
                errorMessage += 'Please try again or use a different search term.';
            }

            document.getElementById('businessGrid').innerHTML = `<div class="error">${errorMessage}</div>`;
            document.getElementById('resultsCount').textContent = 'Search failed';
        }

        // Enable location
        function enableLocation() {
            const btn = document.getElementById('locationBtn');
            btn.disabled = true;
            btn.textContent = '📍 Getting location...';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        if (window.userMarker) {
                            map.removeLayer(window.userMarker);
                        }
                        
                        window.userMarker = L.marker([userLocation.lat, userLocation.lng], {
                            icon: L.icon({
                                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiMzYjgyZjYiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMyIgZmlsbD0id2hpdGUiLz4KPC9zdmc+',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map).bindPopup('Your location');
                        
                        map.setView([userLocation.lat, userLocation.lng], 12);
                        
                        btn.textContent = '📍 Location enabled';
                        btn.style.background = '#10b981';
                        
                        // Automatically search for nearby businesses
                        const parsedQuery = { businessName: '', location: '', original: '' };
                        searchBusinesses(parsedQuery, userLocation.lat, userLocation.lng, currentCategory);
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        btn.disabled = false;
                        btn.textContent = '📍 Enable Location';
                        showError('Unable to get your location. Please check your browser settings.');
                    }
                );
            } else {
                btn.disabled = false;
                btn.textContent = '📍 Enable Location';
                showError('Geolocation is not supported by this browser.');
            }
        }

        // Filter by category
        function filterByCategory(category) {
            currentCategory = category;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const query = document.getElementById('searchInput').value.trim();
            if (query || userLocation) {
                const parsedQuery = parseSearchQuery(query);
                searchBusinesses(parsedQuery, userLocation?.lat, userLocation?.lng, category);
            }
        }

        // Switch view
        function switchView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const container = document.getElementById('contentContainer');
            const mapContainer = document.getElementById('mapContainer');
            const businessGrid = document.getElementById('businessGrid');
            
            switch(view) {
                case 'split':
                    container.style.flexDirection = 'row';
                    mapContainer.style.display = 'block';
                    businessGrid.style.display = 'block';
                    break;
                case 'map':
                    container.style.flexDirection = 'row';
                    mapContainer.style.display = 'block';
                    businessGrid.style.display = 'none';
                    break;
                case 'list':
                    container.style.flexDirection = 'row';
                    mapContainer.style.display = 'none';
                    businessGrid.style.display = 'block';
                    break;
            }
            
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 100);
        }

        // Get directions
        function getDirections(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openLoginModal() {
            openModal('loginModal');
        }

        function openSignupModal() {
            showSuccess('Sign up feature coming soon! Contact us for early access.');
        }

        // Handle login
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                currentUser = { username, isAdmin: true };
                closeModal('loginModal');
                openModal('adminModal');
                showSuccess('Welcome, Admin!');
            } else {
                showError('Invalid credentials. Please try again.');
            }
        }

        // Show admin section
        function showAdminSection(section) {
            const content = document.getElementById('adminSectionContent');
            
            switch(section) {
                case 'users':
                    content.innerHTML = `
                        <h3>User Management</h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <p><strong>Total Users:</strong> 1,247</p>
                            <p><strong>Active Today:</strong> 89</p>
                            <p><strong>New This Week:</strong> 23</p>
                        </div>
                    `;
                    break;
                case 'businesses':
                    content.innerHTML = `
                        <h3>Business Management</h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <p><strong>Total Businesses:</strong> ${businesses.length}</p>
                            <p><strong>Truck Stops:</strong> ${businesses.filter(b => b.isTruckStop).length}</p>
                            <p><strong>Rest Areas:</strong> ${businesses.filter(b => b.isRestArea).length}</p>
                            <p><strong>Verified:</strong> ${Math.floor(businesses.length * 0.75)}</p>
                            <p><strong>Pending Verification:</strong> ${Math.floor(businesses.length * 0.25)}</p>
                        </div>
                    `;
                    break;
                case 'reviews':
                    content.innerHTML = `
                        <h3>Review Moderation</h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <p><strong>Total Reviews:</strong> 3,891</p>
                            <p><strong>Pending Moderation:</strong> 12</p>
                            <p><strong>Flagged Reviews:</strong> 3</p>
                        </div>
                    `;
                    break;
            }
        }

        // Placeholder functions
        function openBusinessOwnerSignup() {
            showSuccess('Business owner signup feature coming soon! Contact us for early access.');
        }

        function openRatingModal(businessId) {
            showSuccess('Rating feature coming soon! Thank you for your interest in helping the community.');
        }

        function openBusinessDetails(businessId) {
            const business = businesses.find(b => b.id === businessId);
            if (business) {
                showSuccess(`Viewing details for ${business.name}. Full details page coming soon!`);
            }
        }

        // Utility functions
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '140px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '3000';
            errorDiv.style.maxWidth = '400px';
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '140px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '3000';
            successDiv.style.maxWidth = '400px';
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>

