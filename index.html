<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Got To Go On The Go - Find Clean Restrooms</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    
    <!-- Meta Tags for SEO and Social Sharing -->
    <meta name="description" content="Find clean, safe restrooms anywhere in the USA. Specializing in truck stops, rest areas, gas stations, and traveler-friendly locations.">
    <!-- Force Deploy: September 17, 2025 - Real Geoapify Integration -->
    <meta name="keywords" content="restroom finder, bathroom locator, truck stops, rest areas, travel, clean restrooms, GTGOTG">
    <meta name="author" content="GTGOTG Team">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://gtgotg.com">
    <meta property="og:title" content="Got To Go On The Go - Find Clean Restrooms">
    <meta property="og:description" content="Find clean, safe restrooms anywhere in the USA. Truck stops, rest areas, and more!">
    <meta property="og:image" content="thumbnail.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://gtgotg.com">
    <meta property="twitter:title" content="Got To Go On The Go - Find Clean Restrooms">
    <meta property="twitter:description" content="Find clean, safe restrooms anywhere in the USA. Truck stops, rest areas, and more!">
    <meta property="twitter:image" content="thumbnail.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .header-logo {
            height: 80px;
            width: auto;
            flex-shrink: 0;
        }

        .header-text {
            text-align: left;
            flex-grow: 1;
            min-width: 300px;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin: 0;
            opacity: 0.9;
        }

        .header-subtitle {
            font-size: 1rem;
            opacity: 0.8;
        }

        .admin-link {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            transition: background 0.3s;
            border: none;
            cursor: pointer;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            align-items: start;
        }

        .search-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .search-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
        }

        .location-input-container {
            position: relative;
        }

        .location-input-container input {
            padding: 12px 50px 12px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            width: 100%;
        }

        .current-location-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }

        .current-location-btn:hover {
            background: #5a6fd8;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-item:hover {
            background: #f8f9fa;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .priority-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .priority-btn {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.9rem;
        }

        .priority-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .priority-btn:hover {
            border-color: #667eea;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .map-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: sticky;
            top: 20px;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .map-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .map-expand-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .map-container {
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            transition: height 0.3s ease;
        }

        .map-container.expanded {
            height: 600px;
        }

        .results-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .results-count {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
        }

        .api-badge {
            background: #4CAF50;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .business-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .business-card {
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }

        .business-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .business-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .business-address {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .business-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-tag {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #555;
        }

        .restroom-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-excellent {
            background: #4CAF50;
            color: white;
        }

        .badge-good {
            background: #8BC34A;
            color: white;
        }

        .badge-maybe {
            background: #FF9800;
            color: white;
        }

        .badge-truck-stop {
            background: #FF5722;
            color: white;
        }

        .chain-indicator {
            background: #2196F3;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }

        .review-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .review-button:hover {
            background: #5a6fd8;
        }

        /* Star Rating Styles */
        .star-rating {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .star {
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.3;
        }

        .star:hover,
        .star.active {
            opacity: 1;
            transform: scale(1.1);
        }

        .star.hover {
            opacity: 0.7;
        }

        .rating-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .review-form-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .photo-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            transition: border-color 0.3s;
        }

        .photo-upload-area:hover {
            border-color: #667eea;
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .photo-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 2px solid #ddd;
        }

        .review-display {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: white;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .reviewer-name {
            font-weight: 600;
            color: #333;
        }

        .review-date {
            color: #666;
            font-size: 0.9rem;
        }

        .review-ratings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .rating-item {
            text-align: center;
        }

        .rating-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
        }

        .rating-name {
            font-size: 0.8rem;
            color: #666;
        }

        .review-text {
            margin: 10px 0;
            line-height: 1.5;
        }

        .review-photos {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .review-photos img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .review-photos img:hover {
            transform: scale(1.05);
        }

        .review-tags {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .review-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .review-tag.ada {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .business-reviews {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .reviews-summary {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .average-rating {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }

        .rating-breakdown {
            flex: 1;
        }

        .rating-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }

        .rating-bar-fill {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .rating-bar-value {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* Review Modal Styles */
        .review-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .review-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .rating-section {
            margin: 20px 0;
        }

        .rating-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .star-rating {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .star {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star:hover,
        .star.hover {
            color: #FFA500;
        }

        .star.active {
            color: #FFD700;
        }

        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .amenity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .amenity-item:hover {
            background-color: #f0f8ff;
        }

        .amenity-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .amenity-item label {
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0;
        }

        .login-required {
            background-color: #f5f5f5;
            border: 1px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            color: #666;
            margin: 15px 0;
        }

        .login-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        }

        .review-display {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .review-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .reviewer-name {
            font-weight: 600;
            color: #333;
        }

        .review-date {
            color: #666;
            font-size: 0.9rem;
        }

        .review-ratings {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .review-amenities {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .amenity-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .review-text {
            color: #555;
            line-height: 1.4;
        }

        .trophy-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }

        .badge-first {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: white;
        }

        .badge-milestone {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .badge-veteran {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .badge-expert {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
        }

        .trophy-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
            animation: trophyPop 0.5s ease-out;
        }

        @keyframes trophyPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .map-section {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-text {
                text-align: center;
                min-width: auto;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header-logo {
                height: 60px;
            }
            
            .business-grid {
                grid-template-columns: 1fr;
            }
            
            .priority-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-link">
            <button class="header-btn" onclick="showLogin()" id="loginBtn">👤 Login</button>
            <button class="header-btn" onclick="showRegister()" id="registerBtn">📝 Register</button>
            <button class="header-btn" onclick="showAdminLogin()">🔐 Admin</button>
            <button class="header-btn" onclick="showClaimBusiness()" style="display: none;" id="claimBtn">🏢 Claim Business</button>
            <button class="header-btn" onclick="logout()" style="display: none;" id="logoutBtn">🚪 Logout</button>
        </div>
        
        <div class="header">
            <div class="header-content">
                <img src="logo.png" alt="GTGOTG Logo" class="header-logo">
                <div class="header-text">
                    <h1>Got To Go On The Go</h1>
                    <p style="font-size: 1.2rem;">Find clean, safe restrooms anywhere in the USA</p>
                </div>
            </div>
            <p class="header-subtitle">Truck Stops, Rest Areas & More!</p>
        </div>

        <div class="main-content">
            <div class="search-section">
                <form class="search-form" id="searchForm">
                    <div class="form-group">
                        <label for="location">Location (City, State or Address)</label>
                        <div class="location-input-container">
                            <input type="text" id="location" placeholder="e.g., Denver, CO or I-70 Exit 123" required>
                            <button type="button" class="current-location-btn" onclick="useCurrentLocation()">📍 Current</button>
                            <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="radius">Search Radius</label>
                        <select id="radius">
                            <option value="1609">1 mile</option>
                            <option value="8047" selected>5 miles</option>
                            <option value="16093">10 miles</option>
                            <option value="24140">15 miles</option>
                            <option value="32187">20 miles</option>
                            <option value="40234">25 miles</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="limit">Number of Results</label>
                        <select id="limit">
                            <option value="5">5 locations</option>
                            <option value="10" selected>10 locations</option>
                            <option value="15">15 locations</option>
                            <option value="20">20 locations</option>
                            <option value="25">25 locations</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Priority Categories</label>
                        <div class="priority-buttons">
                            <div class="priority-btn" data-priority="truck_stops">
                                🚛 Truck Stops & Rest Areas
                            </div>
                            <div class="priority-btn" data-priority="gas_stations">
                                ⛽ Gas Stations
                            </div>
                            <div class="priority-btn" data-priority="restaurants">
                                🍔 Restaurants & Fast Food
                            </div>
                            <div class="priority-btn" data-priority="shopping">
                                🏪 Shopping & Retail
                            </div>
                            <div class="priority-btn" data-priority="hotels">
                                🏨 Hotels & Lodging
                            </div>
                            <div class="priority-btn active" data-priority="all">
                                🎯 All Categories
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="search-btn" id="searchBtn">
                        🔍 Find Restrooms
                    </button>
                </form>

                <div class="loading" id="loadingSection" style="display: none;">
                    <p>🔍 Searching for restroom locations...</p>
                </div>

                <div class="error" id="errorSection" style="display: none;"></div>
                <div class="success" id="successSection" style="display: none;"></div>
            </div>

            <div class="map-section">
                <div class="map-header">
                    <div class="map-title">📍 Restroom Locations</div>
                    <button class="map-expand-btn" onclick="toggleMapSize()">
                        <span id="expandText">🔍 Expand</span>
                    </button>
                </div>
                <div id="map" class="map-container"></div>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <div class="results-count" id="resultsCount">0 locations found</div>
                <div class="api-badge">Live Data</div>
            </div>

            <div class="stats" id="statsSection">
                <div class="stat-item">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total Found</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="truckStopCount">0</div>
                    <div class="stat-label">Truck Stops</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="gasStationCount">0</div>
                    <div class="stat-label">Gas Stations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="chainCount">0</div>
                    <div class="stat-label">Chain Stores</div>
                </div>
            </div>

            <div class="business-grid" id="businessGrid"></div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAdminModal()">&times;</span>
            <h2>🔐 Admin Login</h2>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminUsername">Username</label>
                    <input type="text" id="adminUsername" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <button type="submit" class="search-btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard Modal -->
    <div id="dashboardModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDashboardModal()">&times;</span>
            <h2>📊 Admin Dashboard</h2>
            <div id="dashboardContent">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalSearches">0</div>
                        <div class="stat-label">Total Searches</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalReviews">0</div>
                        <div class="stat-label">Reviews</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                </div>
                <h3>Recent Activity</h3>
                <div id="recentActivity">
                    <p>Loading activity...</p>
                </div>
                <h3>Manage Reviews</h3>
                <div id="reviewManagement">
                    <button onclick="loadAllReviews()" class="search-btn" style="margin: 10px 0;">Load All Reviews</button>
                    <div id="allReviews"></div>
                </div>
                <h3>User Management</h3>
                <div id="userManagement">
                    <button onclick="loadAllUsers()" class="search-btn" style="margin: 10px 0;">Load All Users</button>
                    <div id="allUsers"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLoginModal()">&times;</span>
            <h2>👤 User Login</h2>
            
            <!-- Social Login Options -->
            <div style="margin-bottom: 20px;">
                <button onclick="loginWithGoogle()" style="width: 100%; padding: 12px; margin-bottom: 10px; background: #4285f4; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>
                
                <button onclick="loginWithFacebook()" style="width: 100%; padding: 12px; margin-bottom: 15px; background: #1877f2; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                    Continue with Facebook
                </button>
                
                <div style="text-align: center; margin: 15px 0; color: #666; position: relative;">
                    <span style="background: white; padding: 0 15px;">or</span>
                    <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #ddd; z-index: -1;"></div>
                </div>
            </div>
            
            <form id="userLoginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="search-btn">Login</button>
            </form>
        </div>
    </div>

    <!-- User Registration Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRegisterModal()">&times;</span>
            <h2>📝 Create Account</h2>
            
            <!-- Social Login Options -->
            <div style="margin-bottom: 20px;">
                <button onclick="loginWithGoogle()" style="width: 100%; padding: 12px; margin-bottom: 10px; background: #4285f4; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>
                
                <button onclick="loginWithFacebook()" style="width: 100%; padding: 12px; margin-bottom: 15px; background: #1877f2; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                    Continue with Facebook
                </button>
                
                <div style="text-align: center; margin: 15px 0; color: #666; position: relative;">
                    <span style="background: white; padding: 0 15px;">or</span>
                    <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #ddd; z-index: -1;"></div>
                </div>
            </div>
            
            <form id="userRegisterForm">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" required minlength="6">
                </div>
                <button type="submit" class="search-btn">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReviewModal()">&times;</span>
            <h2>⭐ Rate This Restroom</h2>
            <div id="reviewBusinessInfo"></div>
            <form id="reviewForm">
                <div class="form-group">
                    <label>Overall Rating</label>
                    <div class="star-rating" id="overallRating">
                        <span class="star" data-rating="1">⭐</span>
                        <span class="star" data-rating="2">⭐</span>
                        <span class="star" data-rating="3">⭐</span>
                        <span class="star" data-rating="4">⭐</span>
                        <span class="star" data-rating="5">⭐</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Cleanliness</label>
                    <div class="star-rating" id="cleanlinessRating">
                        <span class="star" data-rating="1">🧽</span>
                        <span class="star" data-rating="2">🧽</span>
                        <span class="star" data-rating="3">🧽</span>
                        <span class="star" data-rating="4">🧽</span>
                        <span class="star" data-rating="5">🧽</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Safety</label>
                    <div class="star-rating" id="safetyRating">
                        <span class="star" data-rating="1">🔒</span>
                        <span class="star" data-rating="2">🔒</span>
                        <span class="star" data-rating="3">🔒</span>
                        <span class="star" data-rating="4">🔒</span>
                        <span class="star" data-rating="5">🔒</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="adaCompliant"> ADA Compliant/Accessible
                    </label>
                </div>
                <div class="form-group">
                    <label for="bathroomType">Bathroom Type</label>
                    <select id="bathroomType">
                        <option value="separate">Separate Male/Female</option>
                        <option value="unisex">Unisex/Family</option>
                        <option value="single">Single Occupancy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reviewText">Your Review</label>
                    <textarea id="reviewText" rows="4" placeholder="Share your experience..."></textarea>
                </div>
                <div class="form-group">
                    <label for="reviewPhotos">Upload Photos</label>
                    <div class="photo-upload-area">
                        <input type="file" id="reviewPhotos" multiple accept="image/*" style="display: none;">
                        <div onclick="document.getElementById('reviewPhotos').click()" style="cursor: pointer;">
                            📷 Click to upload photos<br>
                            <small>Upload photos of the restroom conditions (optional)</small>
                        </div>
                    </div>
                    <div class="photo-preview" id="photoPreview"></div>
                </div>
                <button type="submit" class="search-btn">Submit Review</button>
            </form>
        </div>
    </div>

    <!-- Claim Business Modal -->
    <div id="claimBusinessModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeClaimBusinessModal()">&times;</span>
            <h2>🏢 Claim Your Business</h2>
            <form id="claimBusinessForm">
                <div class="form-group">
                    <label for="businessName">Business Name</label>
                    <input type="text" id="businessName" required>
                </div>
                <div class="form-group">
                    <label for="businessAddress">Business Address</label>
                    <input type="text" id="businessAddress" required>
                </div>
                <div class="form-group">
                    <label for="businessPhone">Phone Number</label>
                    <input type="tel" id="businessPhone" required>
                </div>
                <div class="form-group">
                    <label for="businessEmail">Business Email</label>
                    <input type="email" id="businessEmail" required>
                </div>
                <div class="form-group">
                    <label for="ownershipProof">Proof of Ownership</label>
                    <input type="file" id="ownershipProof" accept=".pdf,.jpg,.png" required>
                    <small>Upload business license, utility bill, or other proof of ownership</small>
                </div>
                <div class="form-group">
                    <label for="claimReason">Why are you claiming this business?</label>
                    <textarea id="claimReason" rows="3" required placeholder="Explain your relationship to this business..."></textarea>
                </div>
                <button type="submit" class="search-btn">Submit Claim Request</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const GEOAPIFY_API_KEY = '505d6b0a6c8d480787a6b3a969e31685';
        let map;
        let markers = [];
        let currentBusinesses = [];
        let autocompleteTimeout;
        
        // Initialize map
        function initMap() {
            try {
                // Wait for Leaflet to be fully loaded
                if (typeof L === 'undefined') {
                    console.error('Leaflet library not loaded');
                    setTimeout(initMap, 100);
                    return;
                }
                
                map = L.map('map').setView([39.8283, -98.5795], 4); // Center of USA
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                
                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Error initializing map:', error);
                // Fallback: show a message instead of map
                document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0; color: #666;">Map loading... Please refresh if this persists.</div>';
            }
        }

        // Autocomplete functionality
        function setupAutocomplete() {
            const locationInput = document.getElementById('location');
            const dropdown = document.getElementById('autocompleteDropdown');

            locationInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (query.length < 3) {
                    dropdown.style.display = 'none';
                    return;
                }

                // Clear previous timeout
                if (autocompleteTimeout) {
                    clearTimeout(autocompleteTimeout);
                }

                // Debounce the API call
                autocompleteTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&apiKey=${GEOAPIFY_API_KEY}&limit=5&format=json`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            displayAutocompleteResults(data.results || []);
                        }
                    } catch (error) {
                        console.warn('Autocomplete failed:', error);
                        dropdown.style.display = 'none';
                    }
                }, 300);
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!locationInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function displayAutocompleteResults(results) {
            const dropdown = document.getElementById('autocompleteDropdown');
            
            if (results.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            dropdown.innerHTML = '';
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = result.formatted;
                
                item.addEventListener('click', function() {
                    document.getElementById('location').value = result.formatted;
                    dropdown.style.display = 'none';
                });
                
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
        }

        // Current location functionality
        async function useCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            const btn = document.querySelector('.current-location-btn');
            const originalText = btn.textContent;
            btn.textContent = '📍 Getting...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(async (position) => {
                try {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Reverse geocode to get address
                    const response = await fetch(`https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lng}&apiKey=${GEOAPIFY_API_KEY}&format=json`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.results && data.results.length > 0) {
                            document.getElementById('location').value = data.results[0].formatted;
                        }
                    }
                } catch (error) {
                    console.error('Reverse geocoding failed:', error);
                    alert('Could not get your current address. Please enter manually.');
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }, (error) => {
                console.error('Geolocation error:', error);
                alert('Could not get your location. Please enter manually.');
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }

        // Restroom categories with truck stops priority
        const restroomCategories = {
            truck_stops: [
                'service.vehicle.fuel',
                'leisure.park',
                'tourism.information',
                'amenity.toilet'
            ],
            gas_stations: [
                'amenity.toilet',
                'service.vehicle.fuel'
            ],
            restaurants: [
                'catering.restaurant',
                'catering.fast_food',
                'catering.cafe'
            ],
            shopping: [
                'commercial.shopping_mall',
                'commercial.supermarket',
                'commercial.department_store'
            ],
            hotels: [
                'accommodation.hotel',
                'accommodation.motel'
            ],
            all: [
                'amenity.toilet',
                'service.vehicle.fuel',
                'commercial.supermarket',
                'accommodation',
                'commercial.shopping_mall',
                'catering',
                'commercial.department_store'
            ]
        };

        const truckStopChains = [
            'pilot', 'flying j', 'loves', 'ta travel centers', 'petro', 'travel centers of america',
            'pilot flying j', 'loves travel stops', 'ta petro', 'road ranger', 'roady\'s',
            'sapp bros', 'iowa 80', 'truck stops of america', 'ambest', 'maverik',
            'rest area', 'service area', 'welcome center', 'travel plaza',
            'truck plaza', 'service plaza', 'highway services'
        ];

        // Priority button handling
        document.querySelectorAll('.priority-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await searchBusinesses();
        });

        async function searchBusinesses() {
            const location = document.getElementById('location').value.trim();
            const radius = document.getElementById('radius').value;
            const limit = document.getElementById('limit').value;
            const priority = document.querySelector('.priority-btn.active').dataset.priority;
            
            if (!location) {
                showError('Please enter a location');
                return;
            }

            showLoading(true);
            hideError();
            hideSuccess();
            hideResults();

            try {
                console.log('Starting search for:', location);
                
                // Geocode the location
                const geocodeUrl = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(location)}&apiKey=${GEOAPIFY_API_KEY}&limit=1&format=json`;
                console.log('Geocoding URL:', geocodeUrl);
                
                const geocodeResponse = await fetch(geocodeUrl);
                console.log('Geocoding response status:', geocodeResponse.status);

                if (!geocodeResponse.ok) {
                    const errorText = await geocodeResponse.text();
                    console.error('Geocoding API error:', geocodeResponse.status, errorText);
                    throw new Error(`Geocoding failed: ${geocodeResponse.status}`);
                }

                const geocodeData = await geocodeResponse.json();
                console.log('Geocoding data:', geocodeData);
                
                if (!geocodeData.results || geocodeData.results.length === 0) {
                    throw new Error('Location not found. Please try a different location or be more specific (e.g., "Denver, CO" instead of just "Denver")');
                }

                const result = geocodeData.results[0];
                const latitude = result.lat;
                const longitude = result.lon;
                const formattedAddress = result.formatted;

                console.log('Coordinates found:', latitude, longitude);

                // Get appropriate categories
                const categories = restroomCategories[priority].join(',');
                console.log('Using categories:', categories);

                const placesUrl = `https://api.geoapify.com/v2/places?categories=${categories}&filter=circle:${longitude},${latitude},${radius}&limit=${limit}&apiKey=${GEOAPIFY_API_KEY}`;
                console.log('Places URL:', placesUrl);
                
                const placesResponse = await fetch(placesUrl);
                console.log('Places response status:', placesResponse.status);

                if (!placesResponse.ok) {
                    const errorText = await placesResponse.text();
                    console.error('Places API error:', placesResponse.status, errorText);
                    throw new Error(`Search failed: ${placesResponse.status}`);
                }

                const placesData = await placesResponse.json();
                console.log('Places data:', placesData);
                
                let businesses = placesData.features || [];
                console.log('Found businesses:', businesses.length);

                // Process and filter businesses
                businesses = processBusinesses(businesses, latitude, longitude, priority);

                currentBusinesses = businesses;
                updateMap(businesses, latitude, longitude);
                showSuccess(`Found ${businesses.length} restroom locations near ${formattedAddress}`);
                displayResults(businesses, formattedAddress);

                // Track search for admin dashboard
                trackSearch(location, businesses.length);

            } catch (error) {
                console.error('Search error:', error);
                showError(`Search failed: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function processBusinesses(businesses, searchLat, searchLng, priority) {
            // Calculate distances and scores
            businesses = businesses.map(business => {
                const coords = business.geometry.coordinates;
                const distance = calculateDistance(searchLat, searchLng, coords[1], coords[0]);
                const restroomProbability = calculateRestroomProbability(business, priority);
                const isChain = isChainStore(business.properties.name);
                const isTruckStop = isTruckStopLocation(business);
                
                return { 
                    ...business, 
                    distance, 
                    restroomProbability,
                    isChain,
                    isTruckStop
                };
            });

            // Sort by priority: truck stops first, then by probability, then by distance
            businesses.sort((a, b) => {
                if (a.isTruckStop && !b.isTruckStop) return -1;
                if (!a.isTruckStop && b.isTruckStop) return 1;
                
                if (a.restroomProbability !== b.restroomProbability) {
                    return b.restroomProbability - a.restroomProbability;
                }
                
                return a.distance - b.distance;
            });

            return businesses;
        }

        function calculateRestroomProbability(business, priority) {
            const props = business.properties;
            const name = (props.name || '').toLowerCase();
            const categories = props.categories || [];
            
            let score = 50; // Base score

            // Truck stops and rest areas get highest priority
            if (isTruckStopLocation(business)) {
                score += 45;
            }

            // Category-based scoring
            if (categories.some(cat => cat.includes('gas_station'))) score += 40;
            if (categories.some(cat => cat.includes('rest_area'))) score += 45;
            if (categories.some(cat => cat.includes('truck_stop'))) score += 45;
            if (categories.some(cat => cat.includes('supermarket'))) score += 35;
            if (categories.some(cat => cat.includes('accommodation'))) score += 35;
            if (categories.some(cat => cat.includes('restaurant'))) score += 30;
            if (categories.some(cat => cat.includes('fast_food'))) score += 30;

            // Chain store bonus
            if (isChainStore(name)) {
                score += 15;
            }

            // Size indicators
            if (['truck stop', 'travel center', 'plaza', 'station'].some(word => name.includes(word))) {
                score += 20;
            }

            return Math.min(score, 95);
        }

        function isTruckStopLocation(business) {
            const name = (business.properties.name || '').toLowerCase();
            const categories = business.properties.categories || [];
            
            // Check for actual truck stop chains first
            const isActualTruckStop = truckStopChains.some(chain => name.includes(chain));
            
            // Check for truck stop keywords in name
            const truckStopKeywords = [
                'truck stop', 'travel center', 'travel centre', 'rest area', 'service plaza',
                'truck plaza', 'travel plaza', 'service center', 'welcome center',
                'rest stop', 'highway services', 'interstate services'
            ];
            const hasKeywords = truckStopKeywords.some(keyword => name.includes(keyword));
            
            // Check categories for rest areas and fuel services
            const hasRelevantCategory = categories.some(cat => 
                cat.includes('rest_area') || 
                (cat.includes('fuel') && name.includes('truck'))
            );
            
            // Exclude common false positives
            const falsePositives = [
                'taco bell', 'target', 'walmart', 'mcdonalds', 'burger king',
                'subway', 'kfc', 'pizza', 'starbucks', 'dunkin', 'wendys',
                'home depot', 'lowes', 'best buy', 'cvs', 'walgreens'
            ];
            const isFalsePositive = falsePositives.some(fp => name.includes(fp));
            
            return (isActualTruckStop || hasKeywords || hasRelevantCategory) && !isFalsePositive;
            // Check for rest area and service area categories
            const isRestAreaCategory = categories.some(cat => 
                cat.includes('rest_area') || 
                cat.includes('services') || 
                cat.includes('tourism.information') ||
                cat.includes('leisure.park')
            );
            
            // Check for truck stop/rest area keywords in name
            const hasRestAreaKeywords = [
                'rest area', 'service area', 'welcome center', 'travel plaza',
                'truck plaza', 'service plaza', 'highway services', 'rest stop',
                'travel center', 'truck stop', 'interstate', 'highway rest'
            ].some(term => name.includes(term));
            
            return isTruckStopName || isRestAreaCategory || hasRestAreaKeywords;
        }

        function isChainStore(name) {
            const nameLower = (name || '').toLowerCase();
            return truckStopChains.some(chain => nameLower.includes(chain));
        }

        function updateMap(businesses, centerLat, centerLng) {
            try {
                if (!map) {
                    console.warn('Map not initialized, skipping update');
                    return;
                }
                
                // Clear existing markers
                markers.forEach(marker => {
                    try {
                        map.removeLayer(marker);
                    } catch (e) {
                        console.warn('Error removing marker:', e);
                    }
                });
                markers = [];

                // Set map center and zoom
                map.setView([centerLat, centerLng], 10);

                // Add markers for businesses
                businesses.forEach(business => {
                    try {
                        const coords = business.geometry.coordinates;
                        const props = business.properties;
                        
                        let icon = '🚽';
                        if (business.isTruckStop) icon = '🚛';
                        else if (props.categories?.some(cat => cat.includes('gas_station'))) icon = '⛽';
                        else if (props.categories?.some(cat => cat.includes('restaurant'))) icon = '🍔';
                        else if (props.categories?.some(cat => cat.includes('hotel'))) icon = '🏨';

                        const marker = L.marker([coords[1], coords[0]], {
                            icon: L.divIcon({
                                html: `<div style="background: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid #667eea; font-size: 16px;">${icon}</div>`,
                                className: 'custom-marker',
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            })
                        }).addTo(map);

                        marker.bindPopup(`
                            <div style="min-width: 200px;">
                                <h3>${props.name}</h3>
                                <p>${props.formatted}</p>
                                <p><strong>Distance:</strong> ${business.distance.toFixed(2)} miles</p>
                                <p><strong>Restroom Probability:</strong> ${business.restroomProbability}%</p>
                                ${business.isTruckStop ? '<p><strong>🚛 Truck Stop/Rest Area</strong></p>' : ''}
                                <button onclick="reviewBusiness('${props.name}', '${props.formatted}')" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">Rate Restroom</button>
                            </div>
                        `);

                        markers.push(marker);
                    } catch (error) {
                        console.warn('Error adding marker for business:', business.properties?.name, error);
                    }
                });
                
                console.log(`Added ${markers.length} markers to map`);
            } catch (error) {
                console.error('Error updating map:', error);
            }
        }

        function toggleMapSize() {
            try {
                const mapContainer = document.getElementById('map');
                const expandText = document.getElementById('expandText');
                
                if (mapContainer.classList.contains('expanded')) {
                    mapContainer.classList.remove('expanded');
                    expandText.textContent = '🔍 Expand';
                } else {
                    mapContainer.classList.add('expanded');
                    expandText.textContent = '📉 Collapse';
                }
                
                // Refresh map after size change
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 300);
            } catch (error) {
                console.error('Error toggling map size:', error);
            }
        }

        function displayResults(businesses, searchLocation) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsCount = document.getElementById('resultsCount');
            const businessGrid = document.getElementById('businessGrid');
            
            // Calculate stats
            const stats = {
                total: businesses.length,
                truckStops: businesses.filter(b => b.isTruckStop).length,
                gasStations: businesses.filter(b => 
                    b.properties.categories?.some(cat => cat.includes('gas_station'))
                ).length,
                chains: businesses.filter(b => b.isChain).length
            };

            // Update stats
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('truckStopCount').textContent = stats.truckStops;
            document.getElementById('gasStationCount').textContent = stats.gasStations;
            document.getElementById('chainCount').textContent = stats.chains;

            resultsCount.textContent = `${businesses.length} restroom locations found near ${searchLocation}`;
            
            // Clear previous results
            businessGrid.innerHTML = '';
            
            if (businesses.length === 0) {
                businessGrid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">No restroom locations found. Try expanding your search radius or changing categories.</p>';
            } else {
                businesses.forEach(business => {
                    const businessCard = createBusinessCard(business);
                    businessGrid.appendChild(businessCard);
                });
            }
            
            resultsSection.style.display = 'block';
        }

        function createBusinessCard(business) {
            const card = document.createElement('div');
            card.className = 'business-card';
            
            const props = business.properties;
            const category = props.categories ? props.categories[0].split('.').pop() : 'business';
            const phone = props.contact?.phone || '';
            const hours = props.opening_hours || '';
            
            // Create restroom badge
            const restroomBadge = createRestroomBadge(business.restroomProbability, business.isTruckStop);
            const chainIndicator = business.isChain ? '<span class="chain-indicator">CHAIN</span>' : '';

            card.innerHTML = `
                ${restroomBadge}
                <div class="business-name">
                    ${props.name || 'Unknown Business'}
                    ${chainIndicator}
                </div>
                <div class="business-address">📍 ${props.formatted || 'Address not available'}</div>
                <div class="business-details">
                    <span class="detail-tag">${business.isTruckStop ? '🚛' : '🏪'} ${category}</span>
                    ${phone ? `<span class="detail-tag">📞 ${phone}</span>` : ''}
                    <span class="detail-tag">📏 ${business.distance.toFixed(2)} miles</span>
                    <span class="detail-tag">🚽 ${business.restroomProbability}% likely</span>
                    ${hours ? `<span class="detail-tag">🕒 Open</span>` : ''}
                </div>
                <button class="review-button" onclick="reviewBusiness('${(props.name || 'Unknown').replace(/'/g, "\\'").replace(/"/g, '\\"')}', '${(props.formatted || '').replace(/'/g, "\\'").replace(/"/g, '\\"')}')">
                    ⭐ Rate This Restroom
                </button>
            `;
            
            // Add click handler to focus on map
            card.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    const coords = business.geometry.coordinates;
                    map.setView([coords[1], coords[0]], 15);
                    
                    // Find and open the corresponding marker popup
                    markers.forEach(marker => {
                        if (marker.getLatLng().lat === coords[1] && marker.getLatLng().lng === coords[0]) {
                            marker.openPopup();
                        }
                    });
                }
            });
            
            return card;
        }

        function createRestroomBadge(probability, isTruckStop) {
            let badgeClass, badgeText;
            
            if (isTruckStop) {
                badgeClass = 'badge-truck-stop';
                badgeText = '🚛 Truck Stop';
            } else if (probability >= 90) {
                badgeClass = 'badge-excellent';
                badgeText = '🚽 Restroom Likely';
            } else if (probability >= 70) {
                badgeClass = 'badge-good';
                badgeText = '🚽 Probably Has';
            } else {
                badgeClass = 'badge-maybe';
                badgeText = '🚽 May Have';
            }
            
            return `<div class="restroom-badge ${badgeClass}">${badgeText}</div>`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function resetStarRatings() {
            // Reset all star ratings to 0
            ['overall', 'cleanliness', 'safety'].forEach(type => {
                const stars = document.querySelectorAll(`#${type}Rating .star`);
                stars.forEach(star => {
                    star.classList.remove('active');
                });
                // Reset the hidden input value
                const input = document.querySelector(`input[name="${type}Rating"]`);
                if (input) {
                    input.value = '0';
                }
            });
        }

        function reviewBusiness(businessName, businessAddress) {
            currentReviewBusiness = { name: businessName, address: businessAddress };
            document.getElementById('reviewBusinessName').textContent = businessName;
            document.getElementById('reviewBusinessAddress').textContent = businessAddress;
            
            resetStarRatings();
            resetReviewForm();
            updateLoginRequiredFields();
            
            document.getElementById('reviewModal').style.display = 'block';
        }

        function resetStarRatings() {
            ratings = { overall: 0, cleanliness: 0, safety: 0 };
            document.querySelectorAll('.star-rating .star').forEach(star => {
                star.classList.remove('active');
            });
        }

        function resetReviewForm() {
            document.getElementById('reviewForm').reset();
            document.querySelectorAll('input[name="amenities"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function updateLoginRequiredFields() {
            const reviewText = document.getElementById('reviewText');
            const reviewPhotos = document.getElementById('reviewPhotos');
            const loginPrompt = document.getElementById('loginPrompt');
            
            if (currentUser) {
                reviewText.disabled = false;
                reviewText.placeholder = "Share your experience...";
                reviewPhotos.disabled = false;
                loginPrompt.style.display = 'none';
            } else {
                reviewText.disabled = true;
                reviewText.placeholder = "Login required to write reviews...";
                reviewPhotos.disabled = true;
                loginPrompt.style.display = 'block';
            }
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
            currentReviewBusiness = null;
        }

        function showLoginForReview() {
            // Simple login simulation - in production, use proper authentication
            const username = prompt("Enter username:");
            if (username && username.trim()) {
                currentUser = { username: username.trim(), loginTime: new Date() };
                updateLoginRequiredFields();
                showSuccess(`Welcome back, ${currentUser.username}!`);
            }
        }

        // Star rating functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('star')) {
                const ratingType = e.target.closest('.star-rating').dataset.rating;
                const value = parseInt(e.target.dataset.value);
                const stars = e.target.closest('.star-rating').querySelectorAll('.star');
                
                ratings[ratingType] = value;
                
                stars.forEach((star, index) => {
                    if (index < value) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }
        });

        // Star rating hover effects
        document.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('star')) {
                const value = parseInt(e.target.dataset.value);
                const stars = e.target.closest('.star-rating').querySelectorAll('.star');
                
                stars.forEach((star, index) => {
                    if (index < value) {
                        star.classList.add('hover');
                    } else {
                        star.classList.remove('hover');
                    }
                });
            }
        });

        document.addEventListener('mouseout', function(e) {
            if (e.target.classList.contains('star')) {
                const stars = e.target.closest('.star-rating').querySelectorAll('.star');
                stars.forEach(star => {
                    star.classList.remove('hover');
                });
            }
        });

        // Review form submission
        document.getElementById('reviewForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitReview();
        });

        function submitReview() {
            if (ratings.overall === 0) {
                alert('Please provide an overall rating');
                return;
            }

            const amenities = Array.from(document.querySelectorAll('input[name="amenities"]:checked'))
                .map(checkbox => ({
                    value: checkbox.value,
                    label: checkbox.nextElementSibling.textContent
                }));

            const review = {
                businessName: currentReviewBusiness.name,
                businessAddress: currentReviewBusiness.address,
                ratings: { ...ratings },
                amenities: amenities,
                bathroomType: document.getElementById('bathroomType').value,
                adaCompliant: document.getElementById('adaCompliant').checked,
                reviewText: document.getElementById('reviewText').value,
                reviewer: currentUser ? currentUser.username : 'Anonymous',
                timestamp: new Date().toISOString(),
                photos: [] // Photo handling would be implemented here
            };

            // Save review to localStorage
            const reviews = JSON.parse(localStorage.getItem('restroomReviews') || '[]');
            reviews.push(review);
            localStorage.setItem('restroomReviews', JSON.stringify(reviews));

            // Check for trophies
            if (currentUser) {
                checkAndAwardTrophies(review);
            }

            // Update business card with new review
            updateBusinessCardWithReview(currentReviewBusiness.name);

            showSuccess('Review submitted successfully!');
            closeReviewModal();
        }

        function checkAndAwardTrophies(review) {
            const reviews = JSON.parse(localStorage.getItem('restroomReviews') || '[]');
            const userReviews = reviews.filter(r => r.reviewer === currentUser.username);
            const businessReviews = reviews.filter(r => 
                r.businessName === review.businessName && 
                r.businessAddress === review.businessAddress
            );

            let trophies = JSON.parse(localStorage.getItem('userTrophies') || '{}');
            if (!trophies[currentUser.username]) {
                trophies[currentUser.username] = [];
            }

            let newTrophies = [];

            // First reviewer trophy
            if (businessReviews.length === 1) {
                const firstTrophy = {
                    type: 'first',
                    business: review.businessName,
                    timestamp: new Date().toISOString()
                };
                trophies[currentUser.username].push(firstTrophy);
                newTrophies.push('🥇 First Reviewer at ' + review.businessName);
            }

            // Milestone trophies (every 5 reviews)
            const reviewCount = userReviews.length;
            if (reviewCount % 5 === 0 && reviewCount > 0) {
                let trophyType, trophyText;
                if (reviewCount >= 25) {
                    trophyType = 'expert';
                    trophyText = '👑 Expert Reviewer';
                } else if (reviewCount >= 10) {
                    trophyType = 'veteran';
                    trophyText = '🎖️ Veteran Reviewer';
                } else {
                    trophyType = 'milestone';
                    trophyText = '🏆 Milestone Reviewer';
                }

                const milestoneTrophy = {
                    type: trophyType,
                    reviewCount: reviewCount,
                    timestamp: new Date().toISOString()
                };
                trophies[currentUser.username].push(milestoneTrophy);
                newTrophies.push(trophyText + ` (${reviewCount} reviews)`);
            }

            localStorage.setItem('userTrophies', JSON.stringify(trophies));

            // Show trophy notification
            if (newTrophies.length > 0) {
                showTrophyNotification(newTrophies);
            }
        }

        function showTrophyNotification(trophies) {
            const notification = document.createElement('div');
            notification.className = 'trophy-notification';
            notification.innerHTML = `
                <h3>🎉 Trophy Earned!</h3>
                ${trophies.map(trophy => `<p>${trophy}</p>`).join('')}
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                document.body.removeChild(notification);
            }, 4000);
        }

        function getUserTrophyBadges(username) {
            const trophies = JSON.parse(localStorage.getItem('userTrophies') || '{}');
            const userTrophies = trophies[username] || [];
            
            let badges = [];
            
            // Count first reviewer badges
            const firstCount = userTrophies.filter(t => t.type === 'first').length;
            if (firstCount > 0) {
                badges.push(`<span class="trophy-badge badge-first">🥇 First ${firstCount > 1 ? 'x' + firstCount : ''}</span>`);
            }
            
            // Get highest milestone badge
            const milestones = userTrophies.filter(t => ['milestone', 'veteran', 'expert'].includes(t.type));
            if (milestones.length > 0) {
                const latest = milestones[milestones.length - 1];
                let badgeClass, badgeText;
                
                switch (latest.type) {
                    case 'expert':
                        badgeClass = 'badge-expert';
                        badgeText = '👑 Expert';
                        break;
                    case 'veteran':
                        badgeClass = 'badge-veteran';
                        badgeText = '🎖️ Veteran';
                        break;
                    default:
                        badgeClass = 'badge-milestone';
                        badgeText = '🏆 Milestone';
                }
                
                badges.push(`<span class="trophy-badge ${badgeClass}">${badgeText}</span>`);
            }
            
            return badges.join('');
        }

        function updateBusinessCardWithReview(businessName) {
            const reviews = JSON.parse(localStorage.getItem('restroomReviews') || '[]');
            const businessReviews = reviews.filter(r => r.businessName === businessName);
            
            if (businessReviews.length === 0) return;
            
            // Calculate average ratings
            const avgOverall = businessReviews.reduce((sum, r) => sum + r.ratings.overall, 0) / businessReviews.length;
            const avgCleanliness = businessReviews.reduce((sum, r) => sum + r.ratings.cleanliness, 0) / businessReviews.length;
            const avgSafety = businessReviews.reduce((sum, r) => sum + r.ratings.safety, 0) / businessReviews.length;
            
            // Find the business card and update it
            const businessCards = document.querySelectorAll('.business-card');
            businessCards.forEach(card => {
                const nameElement = card.querySelector('.business-name');
                if (nameElement && nameElement.textContent.includes(businessName)) {
                    // Add or update review display
                    let reviewDisplay = card.querySelector('.review-display');
                    if (!reviewDisplay) {
                        reviewDisplay = document.createElement('div');
                        reviewDisplay.className = 'review-display';
                        card.appendChild(reviewDisplay);
                    }
                    
                    reviewDisplay.innerHTML = `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: 600;">⭐ ${avgOverall.toFixed(1)} (${businessReviews.length} review${businessReviews.length > 1 ? 's' : ''})</span>
                                <span style="font-size: 0.8rem; color: #666;">Clean: ${avgCleanliness.toFixed(1)} | Safe: ${avgSafety.toFixed(1)}</span>
                            </div>
                            ${businessReviews.slice(-3).map(review => `
                                <div class="review-card" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <span style="font-weight: 600; font-size: 0.9rem;">
                                            ${review.reviewer}${getUserTrophyBadges(review.reviewer)}
                                        </span>
                                        <span style="color: #666; font-size: 0.8rem;">${new Date(review.timestamp).toLocaleDateString()}</span>
                                    </div>
                                    <div style="display: flex; gap: 10px; margin-bottom: 5px; font-size: 0.8rem;">
                                        <span>⭐ ${review.ratings.overall}</span>
                                        <span>🧽 ${review.ratings.cleanliness}</span>
                                        <span>🛡️ ${review.ratings.safety}</span>
                                    </div>
                                    ${review.amenities.length > 0 ? `
                                        <div style="margin-bottom: 5px;">
                                            ${review.amenities.map(amenity => `<span class="amenity-tag">${amenity.label}</span>`).join(' ')}
                                        </div>
                                    ` : ''}
                                    ${review.reviewText ? `<div style="color: #555; font-size: 0.9rem;">${review.reviewText}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });
                <h3>${businessName}</h3>
                <p>📍 ${businessAddress}</p>
            `;
            
            // Store business info for form submission
            window.currentReviewBusiness = {
                name: businessName,
                address: businessAddress
            };
            
            // Reset form
            document.getElementById('reviewForm').reset();
            resetStarRatings();
            
            // Show modal
            document.getElementById('reviewModal').style.display = 'block';
        }

        // Admin functions
        function showAdminLogin() {
            document.getElementById('adminModal').style.display = 'block';
        }

        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        function closeDashboardModal() {
            document.getElementById('dashboardModal').style.display = 'none';
        }

        document.getElementById('adminLoginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            // Simple admin check (in production, use proper authentication)
            if (username === 'admin' && password === 'gtgotg2025') {
                closeAdminModal();
                showAdminDashboard();
            } else {
                alert('Invalid credentials');
            }
        });

        function showAdminDashboard() {
            // Load dashboard data
            const totalSearches = localStorage.getItem('totalSearches') || '0';
            const totalReviews = localStorage.getItem('totalReviews') || '0';
            const activeUsers = Math.floor(Math.random() * 50) + 10; // Simulated
            
            document.getElementById('totalSearches').textContent = totalSearches;
            document.getElementById('totalReviews').textContent = totalReviews;
            document.getElementById('activeUsers').textContent = activeUsers;
            
            // Load recent activity
            const recentActivity = JSON.parse(localStorage.getItem('recentActivity') || '[]');
            const activityHtml = recentActivity.length > 0 ? 
                recentActivity.slice(-10).map(activity => `<p>${activity}</p>`).join('') :
                '<p>No recent activity</p>';
            
            document.getElementById('recentActivity').innerHTML = activityHtml;
            document.getElementById('dashboardModal').style.display = 'block';
        }

        function trackSearch(location, resultCount) {
            // Update search count
            const currentCount = parseInt(localStorage.getItem('totalSearches') || '0');
            localStorage.setItem('totalSearches', (currentCount + 1).toString());
            
            // Add to recent activity
            const activity = JSON.parse(localStorage.getItem('recentActivity') || '[]');
            activity.push(`Search: ${location} - ${resultCount} results found - ${new Date().toLocaleString()}`);
            localStorage.setItem('recentActivity', JSON.stringify(activity));
        }

        // Social Login Functions
        function loginWithGoogle() {
            // Placeholder functions for missing modal functions
            window.showLogin = function() {
                document.getElementById('loginModal').style.display = 'block';
            };
            
            window.showRegister = function() {
                document.getElementById('registerModal').style.display = 'block';
            };
            
            window.showClaimBusiness = function() {
                document.getElementById('claimBusinessModal').style.display = 'block';
            };
            
            window.closeLoginModal = function() {
                document.getElementById('loginModal').style.display = 'none';
            };
            
            window.closeRegisterModal = function() {
                document.getElementById('registerModal').style.display = 'none';
            };
            
            window.closeReviewModal = function() {
                document.getElementById('reviewModal').style.display = 'none';
            };
            
            window.closeClaimBusinessModal = function() {
                document.getElementById('claimBusinessModal').style.display = 'none';
            };
            
            window.logout = function() {
                localStorage.removeItem('gtgotg_currentUser');
                updateUserInterface();
                showSuccess('Successfully logged out!');
            };
            
            window.updateUserInterface = function() {
                // Update UI based on login status
                const currentUser = JSON.parse(localStorage.getItem('gtgotg_currentUser') || 'null');
                const loginBtn = document.getElementById('loginBtn');
                const registerBtn = document.getElementById('registerBtn');
                const logoutBtn = document.getElementById('logoutBtn');
                const claimBtn = document.getElementById('claimBtn');
                
                if (currentUser) {
                    loginBtn.style.display = 'none';
                    registerBtn.style.display = 'none';
                    logoutBtn.style.display = 'block';
                    claimBtn.style.display = 'block';
                } else {
                    loginBtn.style.display = 'block';
                    registerBtn.style.display = 'block';
                    logoutBtn.style.display = 'none';
                    claimBtn.style.display = 'none';
                }
            };
            
            // In a real app, this would use Google OAuth
            // For demo purposes, we'll simulate the process
            showSuccess('Google login would redirect to Google OAuth. For demo, creating test account...');
            
            // Simulate successful Google login
            setTimeout(() => {
                const googleUser = {
                    id: 'google_' + Date.now(),
                    name: 'Google User',
                    email: 'user@gmail.com',
                    loginMethod: 'google',
                    createdAt: new Date().toISOString()
                };
                
                // Save user and login
                const users = JSON.parse(localStorage.getItem('gtgotg_users') || '[]');
                const existingUser = users.find(u => u.email === googleUser.email);
                
                if (!existingUser) {
                    users.push(googleUser);
                    localStorage.setItem('gtgotg_users', JSON.stringify(users));
                }
                
                localStorage.setItem('gtgotg_currentUser', JSON.stringify(googleUser));
                
                // Enable photo upload and written reviews when logged in
                document.getElementById('reviewPhotos').disabled = false;
                const reviewTextarea = document.querySelector('textarea[placeholder*="Login required"]');
                if (reviewTextarea) {
                    reviewTextarea.placeholder = "Share your experience with this restroom...";
                }
                
                updateUserInterface();
                closeLoginModal();
                closeRegisterModal();
                showSuccess('Successfully logged in with Google!');
            }, 1000);
        }
        
        function loginWithFacebook() {
            // In a real app, this would use Facebook OAuth
            // For demo purposes, we'll simulate the process
            showSuccess('Facebook login would redirect to Facebook OAuth. For demo, creating test account...');
            
            // Simulate successful Facebook login
            setTimeout(() => {
                const facebookUser = {
                    id: 'facebook_' + Date.now(),
                    name: 'Facebook User',
                    email: 'user@facebook.com',
                    loginMethod: 'facebook',
                    createdAt: new Date().toISOString()
                };
                
                // Save user and login
                const users = JSON.parse(localStorage.getItem('gtgotg_users') || '[]');
                const existingUser = users.find(u => u.email === facebookUser.email);
                
                if (!existingUser) {
                    users.push(facebookUser);
                    localStorage.setItem('gtgotg_users', JSON.stringify(users));
                }
                
                localStorage.setItem('gtgotg_currentUser', JSON.stringify(facebookUser));
                
                // Enable photo upload and written reviews when logged in
                document.getElementById('reviewPhotos').disabled = false;
                const reviewTextarea = document.querySelector('textarea[placeholder*="Login required"]');
                if (reviewTextarea) {
                    reviewTextarea.placeholder = "Share your experience with this restroom...";
                }
                
                updateUserInterface();
                closeLoginModal();
                closeRegisterModal();
                showSuccess('Successfully logged in with Facebook!');
            }, 1000);
        }

        // Use current location function
        function useCurrentLocation() {
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by this browser');
                return;
            }

            const locationInput = document.getElementById('location');
            const btn = document.querySelector('.current-location-btn');
            const originalText = btn.textContent;
            
            btn.textContent = '📍 Getting...';
            btn.disabled = true;
            locationInput.value = 'Getting your location...';
            locationInput.disabled = true;

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Reverse geocode to get address
                        const geocodeUrl = `https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lng}&apiKey=${GEOAPIFY_API_KEY}`;
                        const response = await fetch(geocodeUrl);
                        const data = await response.json();
                        
                        if (data.features && data.features.length > 0) {
                            const address = data.features[0].properties.formatted;
                            locationInput.value = address;
                        } else {
                            locationInput.value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                        }
                        
                        locationInput.disabled = false;
                        btn.textContent = originalText;
                        btn.disabled = false;
                        showSuccess('✅ Current location detected!');
                    } catch (error) {
                        console.error('Reverse geocoding error:', error);
                        locationInput.value = `${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
                        locationInput.disabled = false;
                        btn.textContent = originalText;
                        btn.disabled = false;
                        showSuccess('✅ Current location coordinates detected!');
                    }
                },
                (error) => {
                    locationInput.value = '';
                    locationInput.disabled = false;
                    btn.textContent = originalText;
                    btn.disabled = false;
                    
                    let errorMessage = 'Unable to get your location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Please allow location access and try again.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                        default:
                            errorMessage += 'An unknown error occurred.';
                            break;
                    }
                    showError(errorMessage);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutes
                }
            );
        }

        function showLoading(show) {
            document.getElementById('loadingSection').style.display = show ? 'block' : 'none';
            document.getElementById('searchBtn').disabled = show;
            document.getElementById('searchBtn').textContent = show ? '🔍 Searching...' : '🔍 Find Restrooms';
        }

        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            errorSection.textContent = message;
            errorSection.style.display = 'block';
        }

        function showSuccess(message) {
            const successSection = document.getElementById('successSection');
            successSection.textContent = message;
            successSection.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorSection').style.display = 'none';
        }

        function hideSuccess() {
            document.getElementById('successSection').style.display = 'none';
        }

        function hideResults() {
            document.getElementById('resultsSection').style.display = 'none';
        }

        // Initialize app
        window.addEventListener('load', () => {
            // Initialize missing functions
            window.showLogin = function() {
                document.getElementById('loginModal').style.display = 'block';
            };
            
            window.showRegister = function() {
                document.getElementById('registerModal').style.display = 'block';
            };
            
            window.showClaimBusiness = function() {
                document.getElementById('claimBusinessModal').style.display = 'block';
            };
            
            window.closeLoginModal = function() {
                document.getElementById('loginModal').style.display = 'none';
            };
            
            window.closeRegisterModal = function() {
                document.getElementById('registerModal').style.display = 'none';
            };
            
            window.closeReviewModal = function() {
                document.getElementById('reviewModal').style.display = 'none';
            };
            
            window.closeClaimBusinessModal = function() {
                document.getElementById('claimBusinessModal').style.display = 'none';
            };
            
            window.logout = function() {
                localStorage.removeItem('gtgotg_currentUser');
                updateUserInterface();
                showSuccess('Successfully logged out!');
            };
            
            window.updateUserInterface = function() {
                // Update UI based on login status
                const currentUser = JSON.parse(localStorage.getItem('gtgotg_currentUser') || 'null');
                const loginBtn = document.getElementById('loginBtn');
                const registerBtn = document.getElementById('registerBtn');
                const logoutBtn = document.getElementById('logoutBtn');
                const claimBtn = document.getElementById('claimBtn');
                
                if (currentUser) {
                    loginBtn.style.display = 'none';
                    registerBtn.style.display = 'none';
                    logoutBtn.style.display = 'block';
                    claimBtn.style.display = 'block';
                } else {
                    loginBtn.style.display = 'block';
                    registerBtn.style.display = 'block';
                    logoutBtn.style.display = 'none';
                    claimBtn.style.display = 'none';
                }
            };
            
            // Wait a bit for all resources to load
            setTimeout(() => {
                initMap();
                setupAutocomplete();
                updateUserInterface();
                showSuccess('✅ Ready to find restrooms! Truck stops and rest areas prioritized for travelers.');
            }, 500);
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const adminModal = document.getElementById('adminModal');
            const dashboardModal = document.getElementById('dashboardModal');
            const reviewModal = document.getElementById('reviewModal');
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            const reviewModal = document.getElementById('reviewModal');
            const claimBusinessModal = document.getElementById('claimBusinessModal');
            
            if (event.target === adminModal) {
                adminModal.style.display = 'none';
            }
            if (event.target === dashboardModal) {
                dashboardModal.style.display = 'none';
            }
            if (event.target === reviewModal) {
                reviewModal.style.display = 'none';
            }
            if (event.target === loginModal) {
                loginModal.style.display = 'none';
            }
            if (event.target === registerModal) {
                registerModal.style.display = 'none';
            }
            if (event.target === reviewModal) {
                reviewModal.style.display = 'none';
            }
            if (event.target === claimBusinessModal) {
                claimBusinessModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>