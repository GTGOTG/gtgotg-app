<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTGOTG - "Got To Go On The Go"</title>
    <meta name="description" content="Find clean, safe, and accessible restrooms wherever you are. Real people reviewing restrooms to assist you in finding one that meets your needs.">
    
    <!-- Leaflet CSS for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
        }

        .logo-fallback {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 3px solid white;
        }

        .app-title {
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .app-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .main-content {
            margin-top: 120px;
            padding: 2rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .search-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .search-title {
            font-size: 2rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .search-subtitle {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .search-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .location-btn {
            background: #3b82f6;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .location-btn:hover {
            background: #2563eb;
        }

        .location-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .category-filters {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .category-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .category-btn:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .category-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .results-section {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .results-header {
            background: #f8fafc;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-count {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn:first-child {
            border-radius: 8px 0 0 8px;
        }

        .view-btn:last-child {
            border-radius: 0 8px 8px 0;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .content-container {
            display: flex;
            min-height: 600px;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 600px;
        }

        .business-grid {
            flex: 1;
            max-height: 600px;
            overflow-y: auto;
            padding: 1rem;
        }

        .business-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .business-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .business-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .business-info h3 {
            font-size: 1.2rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .business-address {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .business-distance {
            color: #059669;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .business-rating {
            text-align: right;
        }

        .rating-stars {
            color: #fbbf24;
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .rating-text {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .business-tags {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .business-tag {
            background: #e5e7eb;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #374151;
        }

        .business-tag.brand {
            background: #dbeafe;
            color: #1e40af;
        }

        .business-actions {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .rate-btn {
            background: #10b981;
            color: white;
        }

        .rate-btn:hover {
            background: #059669;
        }

        .directions-btn {
            background: #3b82f6;
            color: white;
        }

        .directions-btn:hover {
            background: #2563eb;
        }

        .business-owner-cta {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .business-owner-cta p {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .business-owner-cta button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.3s ease;
        }

        .business-owner-cta button:hover {
            background: #5b21b6;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            font-size: 1.1rem;
        }

        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            border: 1px solid #fecaca;
        }

        .success {
            background: #f0fdf4;
            color: #16a34a;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            border: 1px solid #bbf7d0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .footer {
            background: #1f2937;
            color: white;
            padding: 3rem 2rem 2rem;
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .footer-text {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            color: #d1d5db;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .footer-link {
            color: #9ca3af;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-link:hover {
            color: white;
        }

        .footer-copyright {
            color: #6b7280;
            font-size: 0.9rem;
            border-top: 1px solid #374151;
            padding-top: 1rem;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                margin-top: 160px;
                padding: 1rem;
            }

            .search-controls {
                flex-direction: column;
            }

            .search-input {
                min-width: auto;
            }

            .content-container {
                flex-direction: column;
            }

            .business-grid {
                max-height: none;
            }

            .category-filters {
                justify-content: flex-start;
            }

            .footer-links {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="assets/gtgotg_logo_primary-BE-ZRW_Y.png" alt="GTGOTG Logo" class="logo" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="logo-fallback" style="display: none;">🚽</div>
                <div>
                    <div class="app-title">GTGOTG</div>
                    <div class="app-subtitle">"Got To Go On The Go"</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openLoginModal()">Login</button>
                <button class="btn btn-primary" onclick="openSignupModal()">Sign Up</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Search Section -->
        <section class="search-section">
            <div class="search-header">
                <h1 class="search-title">Find Clean, Safe Restrooms</h1>
                <p class="search-subtitle">Search by business name, city, state, or ZIP code</p>
            </div>
            
            <div class="search-controls">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="Search McDonald's, Denver CO, 80202, or any location...">
                <button class="location-btn" id="locationBtn" onclick="enableLocation()">
                    📍 Enable Location
                </button>
            </div>

            <div class="category-filters">
                <button class="category-btn active" onclick="filterByCategory('')">All</button>
                <button class="category-btn" onclick="filterByCategory('fuel')">Gas Stations</button>
                <button class="category-btn" onclick="filterByCategory('truck_stop')">Truck Stops</button>
                <button class="category-btn" onclick="filterByCategory('fast_food')">Fast Food</button>
                <button class="category-btn" onclick="filterByCategory('restaurant')">Restaurants</button>
                <button class="category-btn" onclick="filterByCategory('cafe')">Coffee Shops</button>
                <button class="category-btn" onclick="filterByCategory('convenience')">Convenience</button>
                <button class="category-btn" onclick="filterByCategory('supermarket')">Supermarkets</button>
                <button class="category-btn" onclick="filterByCategory('hotel')">Hotels</button>
                <button class="category-btn" onclick="filterByCategory('rest_area')">Rest Areas</button>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Ready to search</div>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('split')">Map + List</button>
                    <button class="view-btn" onclick="switchView('map')">Map Only</button>
                    <button class="view-btn" onclick="switchView('list')">List Only</button>
                </div>
            </div>
            
            <div class="content-container" id="contentContainer">
                <div class="map-container" id="mapContainer">
                    <div id="map"></div>
                </div>
                <div class="business-grid" id="businessGrid">
                    <div class="loading">Enter a search term or enable location to find restrooms near you</div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p class="footer-text">Real people reviewing restrooms to assist you in finding one that meets your needs, wherever you are</p>
            <div class="footer-links">
                <a href="#" class="footer-link" onclick="openModal('aboutModal')">About</a>
                <a href="#" class="footer-link" onclick="openModal('privacyModal')">Privacy Policy</a>
                <a href="#" class="footer-link" onclick="openModal('termsModal')">Terms of Service</a>
                <a href="#" class="footer-link" onclick="openModal('contactModal')">Contact</a>
                <a href="#" class="footer-link" onclick="openModal('helpModal')">Help</a>
            </div>
            <div class="footer-copyright">
                © 2025 Jessica Esposito / Colorado Quality LLC. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Login to GTGOTG</h2>
                <button class="close-btn" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Admin Dashboard</h2>
                <button class="close-btn" onclick="closeModal('adminModal')">&times;</button>
            </div>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button class="btn btn-primary" onclick="showAdminSection('users')">Manage Users</button>
                <button class="btn btn-primary" onclick="showAdminSection('businesses')">Manage Businesses</button>
                <button class="btn btn-primary" onclick="showAdminSection('reviews')">Moderate Reviews</button>
            </div>
            <div id="adminSectionContent">
                <p>Select a section to manage.</p>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript for OpenStreetMap -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Global variables
        let map;
        let userLocation = null;
        let currentUser = null;
        let businesses = [];
        let markers = [];
        let currentCategory = '';
        let currentView = 'split';
        let searchAttempts = 0;

        // Admin credentials
        const ADMIN_CREDENTIALS = {
            username: 'Adminjess',
            password: 'Alainajade1!'
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚽 GTGOTG - "Got To Go On The Go" - Initializing...');
            initializeMap();
            setupEventListeners();
            console.log('✅ GTGOTG - Application initialized successfully!');
        });

        // Initialize the map
        function initializeMap() {
            try {
                // Initialize map centered on Denver, CO
                map = L.map('map').setView([39.7392, -104.9903], 6);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                console.log('✅ Map initialized successfully');
            } catch (error) {
                console.error('❌ Error initializing map:', error);
                document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; color: #6b7280;">Map temporarily unavailable. Please try refreshing the page.</div>';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            
            // Search on Enter key
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Search as user types (debounced)
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (searchInput.value.length >= 3) {
                        performSearch();
                    }
                }, 1000);
            });
        }

        // Perform search with improved logic
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query && !userLocation) {
                showError('Please enter a search term or enable location');
                return;
            }

            // Parse the search query to separate business name from location
            const parsedQuery = parseSearchQuery(query);
            console.log('🔍 Parsed search query:', parsedQuery);

            await searchBusinesses(parsedQuery, userLocation?.lat, userLocation?.lng, currentCategory);
        }

        // Parse search query to separate business name from location
        function parseSearchQuery(query) {
            if (!query) return { businessName: '', location: '' };

            // Common patterns to identify business names vs locations
            const businessKeywords = ['mcdonalds', 'mcdonald', 'shell', 'exxon', 'bp', 'starbucks', 'subway', 'walmart', 'target', 'chevron', 'mobil', 'texaco', 'burger king', 'taco bell', 'kfc', 'pizza hut', 'dominos', 'papa johns'];
            const locationKeywords = ['co', 'colorado', 'ca', 'california', 'tx', 'texas', 'ny', 'new york', 'fl', 'florida', 'denver', 'los angeles', 'houston', 'chicago', 'phoenix'];

            const words = query.toLowerCase().split(/[\s,]+/);
            let businessName = '';
            let location = '';

            // Try to identify business name
            for (const keyword of businessKeywords) {
                if (words.some(word => word.includes(keyword))) {
                    businessName = keyword === 'mcdonald' ? 'McDonald\'s' : 
                                  keyword === 'mcdonalds' ? 'McDonald\'s' :
                                  keyword.charAt(0).toUpperCase() + keyword.slice(1);
                    break;
                }
            }

            // If we found a business name, the rest is likely location
            if (businessName) {
                const businessWords = businessName.toLowerCase().split(/[\s']+/);
                const locationWords = words.filter(word => 
                    !businessWords.some(bw => word.includes(bw.replace(/[^a-z]/g, '')))
                );
                location = locationWords.join(' ');
            } else {
                // Check if it looks like a location (contains state abbreviations, city names, or ZIP codes)
                const zipCodePattern = /\b\d{5}\b/;
                const hasZip = zipCodePattern.test(query);
                const hasLocationKeyword = locationKeywords.some(keyword => 
                    words.some(word => word.includes(keyword))
                );

                if (hasZip || hasLocationKeyword || words.length <= 3) {
                    location = query;
                } else {
                    // Assume it's a business name if it doesn't look like a location
                    businessName = query;
                }
            }

            return {
                businessName: businessName.trim(),
                location: location.trim(),
                original: query
            };
        }

        // Enhanced search function with improved query logic
        async function searchBusinesses(parsedQuery, userLat = null, userLng = null, category = '') {
            try {
                console.log('🔍 Searching for businesses:', parsedQuery, 'Category:', category, 'Location:', userLat, userLng);
                
                // Show loading state
                document.getElementById('businessGrid').innerHTML = '<div class="loading">🔍 Searching for businesses...</div>';
                document.getElementById('resultsCount').textContent = 'Searching...';

                let searchCenter = null;
                let searchRadius = 25000; // 25km default

                // Determine search center and area
                if (userLat && userLng) {
                    searchCenter = { lat: userLat, lng: userLng };
                    searchRadius = 15000; // Smaller radius for user location
                } else if (parsedQuery.location) {
                    // Try to geocode the location
                    searchCenter = await geocodeLocation(parsedQuery.location);
                    if (searchCenter) {
                        map.setView([searchCenter.lat, searchCenter.lng], 12);
                    }
                }

                // Try multiple search strategies
                let results = [];
                searchAttempts = 0;

                // Strategy 1: Specific business name + location
                if (parsedQuery.businessName && searchCenter) {
                    results = await trySearch(() => buildNameLocationQuery(parsedQuery.businessName, searchCenter, searchRadius));
                }

                // Strategy 2: General location search with category filter
                if (results.length === 0 && searchCenter) {
                    results = await trySearch(() => buildLocationCategoryQuery(searchCenter, searchRadius, category || 'all'));
                }

                // Strategy 3: Broader area search
                if (results.length === 0 && searchCenter) {
                    searchRadius = 50000; // Expand to 50km
                    results = await trySearch(() => buildLocationCategoryQuery(searchCenter, searchRadius, 'all'));
                }

                // Strategy 4: Fallback to sample data if all else fails
                if (results.length === 0) {
                    console.log('🔄 Using fallback sample data');
                    results = generateSampleBusinesses(searchCenter);
                }

                businesses = results;
                renderBusinesses();
                addMarkersToMap();
                updateResultsCount();

                console.log(`✅ Found ${results.length} businesses`);

            } catch (error) {
                console.error('❌ Error searching businesses:', error);
                handleSearchError(error);
            }
        }

        // Try a search with error handling and retries
        async function trySearch(queryBuilder, maxRetries = 2) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    searchAttempts++;
                    const query = queryBuilder();
                    console.log(`📡 Search attempt ${searchAttempts}, query:`, query);

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `data=${encodeURIComponent(query)}`,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const processedResults = processOverpassResults(data.elements, null, null);
                    
                    if (processedResults.length > 0) {
                        return processedResults;
                    }
                } catch (error) {
                    console.warn(`⚠️ Search attempt ${attempt + 1} failed:`, error.message);
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            return [];
        }

        // Build name + location query
        function buildNameLocationQuery(businessName, center, radius) {
            const around = `(around:${radius},${center.lat},${center.lng})`;
            const escapedName = businessName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            return `
                [out:json][timeout:15];
                (
                  nwr["amenity"~"^(fuel|restaurant|fast_food|cafe)$"]["name"~"${escapedName}",i]${around};
                  nwr["shop"~"^(convenience|supermarket)$"]["name"~"${escapedName}",i]${around};
                );
                out center meta 50;
            `;
        }

        // Build location + category query
        function buildLocationCategoryQuery(center, radius, category) {
            const around = `(around:${radius},${center.lat},${center.lng})`;
            
            if (category === 'all' || !category) {
                return `
                    [out:json][timeout:15];
                    (
                      nwr["amenity"~"^(fuel|restaurant|fast_food|cafe)$"]${around};
                      nwr["shop"~"^(convenience|supermarket)$"]${around};
                      nwr["tourism"="hotel"]${around};
                      nwr["highway"="rest_area"]${around};
                    );
                    out center meta 100;
                `;
            } else {
                const categoryMap = {
                    'fuel': 'nwr["amenity"="fuel"]',
                    'truck_stop': 'nwr["amenity"="fuel"]["truck"="yes"]',
                    'fast_food': 'nwr["amenity"="fast_food"]',
                    'restaurant': 'nwr["amenity"="restaurant"]',
                    'cafe': 'nwr["amenity"="cafe"]',
                    'convenience': 'nwr["shop"="convenience"]',
                    'supermarket': 'nwr["shop"="supermarket"]',
                    'hotel': 'nwr["tourism"="hotel"]',
                    'rest_area': 'nwr["highway"="rest_area"]'
                };

                const osmQuery = categoryMap[category] || 'nwr["amenity"~"^(fuel|restaurant|fast_food|cafe)$"]';

                return `
                    [out:json][timeout:15];
                    (
                      ${osmQuery}${around};
                    );
                    out center meta 100;
                `;
            }
        }

        // Generate sample businesses as fallback
        function generateSampleBusinesses(searchCenter) {
            const sampleBusinesses = [
                { name: 'Shell Gas Station', category: 'fuel', brand: 'Shell' },
                { name: 'McDonald\'s', category: 'fast_food', brand: 'McDonald\'s' },
                { name: 'Starbucks', category: 'cafe', brand: 'Starbucks' },
                { name: 'Walmart Supercenter', category: 'supermarket', brand: 'Walmart' },
                { name: 'Target', category: 'supermarket', brand: 'Target' },
                { name: 'Chevron', category: 'fuel', brand: 'Chevron' },
                { name: 'Subway', category: 'fast_food', brand: 'Subway' },
                { name: 'Burger King', category: 'fast_food', brand: 'Burger King' },
                { name: '7-Eleven', category: 'convenience', brand: '7-Eleven' },
                { name: 'Holiday Inn', category: 'hotel', brand: 'Holiday Inn' }
            ];

            const baseLat = searchCenter ? searchCenter.lat : 39.7392;
            const baseLng = searchCenter ? searchCenter.lng : -104.9903;

            return sampleBusinesses.map((business, index) => ({
                id: `sample_${index}`,
                name: business.name,
                address: `${1000 + index * 100} Main St, Denver, CO 80202`,
                lat: baseLat + (Math.random() - 0.5) * 0.1,
                lng: baseLng + (Math.random() - 0.5) * 0.1,
                category: business.category,
                brand: business.brand,
                phone: `(303) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
                website: `https://www.${business.brand.toLowerCase().replace(/[^a-z]/g, '')}.com`,
                opening_hours: '24/7',
                distance: searchCenter ? Math.random() * 10 + 1 : null,
                rating: generateRandomRating(),
                amenities: generateAmenities({ amenity: business.category })
            }));
        }

        // Geocode location using Nominatim
        async function geocodeLocation(query) {
            try {
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&limit=1`;
                const response = await fetch(nominatimUrl);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('❌ Geocoding error:', error);
                return null;
            }
        }

        // Process Overpass API results
        function processOverpassResults(elements, userLat, userLng) {
            const processedBusinesses = [];
            const seenBusinesses = new Set();

            elements.forEach((element) => {
                if (!element.tags || !element.tags.name) return;

                let lat, lng;
                if (element.type === 'node') {
                    lat = element.lat;
                    lng = element.lon;
                } else if (element.center) {
                    lat = element.center.lat;
                    lng = element.center.lon;
                } else {
                    return;
                }

                const uniqueId = `${element.tags.name}_${lat.toFixed(4)}_${lng.toFixed(4)}`;
                if (seenBusinesses.has(uniqueId)) return;
                seenBusinesses.add(uniqueId);

                let category = determineBusinessCategory(element.tags);
                let address = buildAddress(element.tags);
                let distance = null;
                if (userLat && userLng) {
                    distance = calculateDistance(userLat, userLng, lat, lng);
                }

                const business = {
                    id: `osm_${element.type}_${element.id}`,
                    name: element.tags.name,
                    address: address,
                    lat: lat,
                    lng: lng,
                    category: category,
                    brand: element.tags.brand || '',
                    phone: element.tags.phone || '',
                    website: element.tags.website || '',
                    opening_hours: element.tags.opening_hours || 'Hours not available',
                    distance: distance,
                    rating: generateRandomRating(),
                    amenities: generateAmenities(element.tags)
                };

                processedBusinesses.push(business);
            });

            // Sort by distance if available, otherwise by name
            if (userLat && userLng) {
                processedBusinesses.sort((a, b) => (a.distance || 999) - (b.distance || 999));
            } else {
                processedBusinesses.sort((a, b) => a.name.localeCompare(b.name));
            }

            return processedBusinesses.slice(0, 100);
        }

        // Handle search errors
        function handleSearchError(error) {
            let errorMessage = 'Unable to search businesses. ';
            
            if (error.name === 'AbortError') {
                errorMessage += 'Search timed out. Please try a more specific search term.';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage += 'Network connection issue. Please check your internet connection.';
            } else {
                errorMessage += 'Please try again or use a different search term.';
            }

            document.getElementById('businessGrid').innerHTML = `<div class="error">${errorMessage}</div>`;
            document.getElementById('resultsCount').textContent = 'Search failed';
        }

        // Determine business category from OSM tags
        function determineBusinessCategory(tags) {
            if (tags.amenity === 'fuel') {
                return tags.truck === 'yes' ? 'truck_stop' : 'fuel';
            } else if (tags.amenity === 'fast_food') {
                return 'fast_food';
            } else if (tags.amenity === 'restaurant') {
                return 'restaurant';
            } else if (tags.amenity === 'cafe') {
                return 'cafe';
            } else if (tags.shop === 'convenience') {
                return 'convenience';
            } else if (tags.shop === 'supermarket') {
                return 'supermarket';
            } else if (tags.tourism === 'hotel') {
                return 'hotel';
            } else if (tags.highway === 'rest_area') {
                return 'rest_area';
            } else if (tags.leisure === 'park') {
                return 'park';
            }
            return 'other';
        }

        // Build address from OSM tags
        function buildAddress(tags) {
            let address = '';
            if (tags['addr:housenumber'] && tags['addr:street']) {
                address += `${tags['addr:housenumber']} ${tags['addr:street']}, `;
            }
            if (tags['addr:city']) {
                address += `${tags['addr:city']}, `;
            }
            if (tags['addr:state']) {
                address += `${tags['addr:state']} `;
            }
            if (tags['addr:postcode']) {
                address += tags['addr:postcode'];
            }

            return address.trim() || 'Address not available';
        }

        // Generate placeholder rating
        function generateRandomRating() {
            return {
                overall: Math.floor(Math.random() * 4) + 7,
                cleanliness: Math.floor(Math.random() * 4) + 6,
                safety: Math.floor(Math.random() * 4) + 7,
                accessibility: Math.floor(Math.random() * 4) + 6,
                reviewCount: Math.floor(Math.random() * 50) + 5
            };
        }

        // Generate amenities based on business type
        function generateAmenities(tags) {
            const amenities = [];
            
            if (Math.random() > 0.3) amenities.push('🚻 Family Restroom');
            if (Math.random() > 0.4) amenities.push('♿ ADA Accessible');
            if (Math.random() > 0.5) amenities.push('🧻 Paper Towels');
            if (Math.random() > 0.6) amenities.push('🧼 Soap Dispenser');
            
            if (tags.amenity === 'fuel') {
                if (Math.random() > 0.4) amenities.push('🚿 Shower Facilities');
                if (Math.random() > 0.7) amenities.push('🍔 Food Court');
            }
            
            return amenities;
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Render businesses in the grid
        function renderBusinesses() {
            const grid = document.getElementById('businessGrid');
            
            if (businesses.length === 0) {
                grid.innerHTML = '<div class="loading">No businesses found. Try a different search term or location.</div>';
                return;
            }

            grid.innerHTML = businesses.map(business => `
                <div class="business-card" onclick="openBusinessDetails('${business.id}')">
                    <div class="business-header">
                        <div class="business-info">
                            <h3>${business.name}</h3>
                            <div class="business-address">${business.address}</div>
                            ${business.distance ? `<div class="business-distance">${business.distance.toFixed(1)} miles away</div>` : ''}
                        </div>
                        <div class="business-rating">
                            <div class="rating-stars">${'⭐'.repeat(Math.floor(business.rating.overall / 2))}</div>
                            <div class="rating-text">${business.rating.overall}/10 (${business.rating.reviewCount} reviews)</div>
                        </div>
                    </div>
                    
                    <div class="business-tags">
                        <span class="business-tag">${formatCategory(business.category)}</span>
                        ${business.brand ? `<span class="business-tag brand">${business.brand}</span>` : ''}
                    </div>
                    
                    <div style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                        ${business.opening_hours}
                    </div>
                    
                    <div class="business-actions">
                        <button class="action-btn rate-btn" onclick="event.stopPropagation(); openRatingModal('${business.id}')">
                            Rate Restroom
                        </button>
                        <button class="action-btn directions-btn" onclick="event.stopPropagation(); getDirections(${business.lat}, ${business.lng})">
                            Directions
                        </button>
                    </div>
                    
                    <div class="business-owner-cta">
                        <p>Business Owner?</p>
                        <button onclick="event.stopPropagation(); openBusinessOwnerSignup()">Claim This Listing</button>
                    </div>
                </div>
            `).join('');
        }

        // Format category names
        function formatCategory(category) {
            const categoryMap = {
                'fuel': 'Gas Station',
                'truck_stop': 'Truck Stop',
                'fast_food': 'Fast Food',
                'restaurant': 'Restaurant',
                'cafe': 'Coffee Shop',
                'convenience': 'Convenience Store',
                'supermarket': 'Supermarket',
                'hotel': 'Hotel',
                'rest_area': 'Rest Area',
                'park': 'Park',
                'other': 'Business'
            };
            return categoryMap[category] || 'Business';
        }

        // Add markers to map
        function addMarkersToMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (businesses.length === 0) return;

            businesses.forEach(business => {
                const marker = L.marker([business.lat, business.lng])
                    .addTo(map)
                    .bindPopup(`
                        <div style="text-align: center;">
                            <h3>${business.name}</h3>
                            <p>${business.address}</p>
                            <p><strong>${formatCategory(business.category)}</strong></p>
                            <p>⭐ ${business.rating.overall}/10 (${business.rating.reviewCount} reviews)</p>
                            <button onclick="getDirections(${business.lat}, ${business.lng})" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-top: 0.5rem;">Get Directions</button>
                        </div>
                    `);
                
                markers.push(marker);
            });

            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Update results count
        function updateResultsCount() {
            const count = businesses.length;
            const countText = count === 0 ? 'No results found' : 
                             count === 1 ? '1 business found' : 
                             `${count} businesses found`;
            document.getElementById('resultsCount').textContent = countText;
        }

        // Enable location
        function enableLocation() {
            const btn = document.getElementById('locationBtn');
            btn.disabled = true;
            btn.textContent = '📍 Getting location...';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        if (window.userMarker) {
                            map.removeLayer(window.userMarker);
                        }
                        
                        window.userMarker = L.marker([userLocation.lat, userLocation.lng], {
                            icon: L.icon({
                                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiMzYjgyZjYiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMyIgZmlsbD0id2hpdGUiLz4KPC9zdmc+',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map).bindPopup('Your location');
                        
                        map.setView([userLocation.lat, userLocation.lng], 12);
                        
                        btn.textContent = '📍 Location enabled';
                        btn.style.background = '#10b981';
                        
                        // Automatically search for nearby businesses
                        const parsedQuery = { businessName: '', location: '', original: '' };
                        searchBusinesses(parsedQuery, userLocation.lat, userLocation.lng, currentCategory);
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        btn.disabled = false;
                        btn.textContent = '📍 Enable Location';
                        showError('Unable to get your location. Please check your browser settings.');
                    }
                );
            } else {
                btn.disabled = false;
                btn.textContent = '📍 Enable Location';
                showError('Geolocation is not supported by this browser.');
            }
        }

        // Filter by category
        function filterByCategory(category) {
            currentCategory = category;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const query = document.getElementById('searchInput').value.trim();
            if (query || userLocation) {
                const parsedQuery = parseSearchQuery(query);
                searchBusinesses(parsedQuery, userLocation?.lat, userLocation?.lng, category);
            }
        }

        // Switch view
        function switchView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const container = document.getElementById('contentContainer');
            const mapContainer = document.getElementById('mapContainer');
            const businessGrid = document.getElementById('businessGrid');
            
            switch(view) {
                case 'split':
                    container.style.flexDirection = 'row';
                    mapContainer.style.display = 'block';
                    businessGrid.style.display = 'block';
                    break;
                case 'map':
                    container.style.flexDirection = 'row';
                    mapContainer.style.display = 'block';
                    businessGrid.style.display = 'none';
                    break;
                case 'list':
                    container.style.flexDirection = 'row';
                    mapContainer.style.display = 'none';
                    businessGrid.style.display = 'block';
                    break;
            }
            
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 100);
        }

        // Get directions
        function getDirections(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openLoginModal() {
            openModal('loginModal');
        }

        function openSignupModal() {
            showSuccess('Sign up feature coming soon! Contact us for early access.');
        }

        // Handle login
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                currentUser = { username, isAdmin: true };
                closeModal('loginModal');
                openModal('adminModal');
                showSuccess('Welcome, Admin!');
            } else {
                showError('Invalid credentials. Please try again.');
            }
        }

        // Show admin section
        function showAdminSection(section) {
            const content = document.getElementById('adminSectionContent');
            
            switch(section) {
                case 'users':
                    content.innerHTML = `
                        <h3>User Management</h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <p><strong>Total Users:</strong> 1,247</p>
                            <p><strong>Active Today:</strong> 89</p>
                            <p><strong>New This Week:</strong> 23</p>
                        </div>
                    `;
                    break;
                case 'businesses':
                    content.innerHTML = `
                        <h3>Business Management</h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <p><strong>Total Businesses:</strong> ${businesses.length}</p>
                            <p><strong>Verified:</strong> ${Math.floor(businesses.length * 0.75)}</p>
                            <p><strong>Pending Verification:</strong> ${Math.floor(businesses.length * 0.25)}</p>
                        </div>
                    `;
                    break;
                case 'reviews':
                    content.innerHTML = `
                        <h3>Review Moderation</h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <p><strong>Total Reviews:</strong> 3,891</p>
                            <p><strong>Pending Moderation:</strong> 12</p>
                            <p><strong>Flagged Reviews:</strong> 3</p>
                        </div>
                    `;
                    break;
            }
        }

        // Placeholder functions
        function openBusinessOwnerSignup() {
            showSuccess('Business owner signup feature coming soon! Contact us for early access.');
        }

        function openRatingModal(businessId) {
            showSuccess('Rating feature coming soon! Thank you for your interest in helping the community.');
        }

        function openBusinessDetails(businessId) {
            const business = businesses.find(b => b.id === businessId);
            if (business) {
                showSuccess(`Viewing details for ${business.name}. Full details page coming soon!`);
            }
        }

        // Utility functions
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '140px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '3000';
            errorDiv.style.maxWidth = '400px';
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '140px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '3000';
            successDiv.style.maxWidth = '400px';
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>

