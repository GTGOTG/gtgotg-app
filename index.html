<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTGOTG - "Got To Go On The Go" | Find Clean, Safe Restrooms Nationwide</title>
    <meta name="description" content="Find clean, safe, and accessible restrooms at ANY business nationwide. Real people reviewing restrooms to help you find the perfect facilities wherever you are in the USA.">
    <meta name="keywords" content="restroom finder, bathroom locator, clean restrooms, public restrooms, restroom reviews, bathroom ratings, travel restrooms, truck stop restrooms, restaurant bathrooms">
    
    <!-- Leaflet CSS for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .logo-fallback {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #8B5CF6, #6366F1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            color: white;
        }

        .app-title {
            color: white;
            font-size: 2.2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            line-height: 1.2;
        }

        .app-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1rem;
            margin-top: 0.5rem;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .help-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .main-content {
            margin-top: 140px;
            padding: 2rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .search-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .search-title {
            font-size: 2.5rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .search-subtitle {
            color: #6b7280;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .search-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .location-btn {
            background: #3b82f6;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .location-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .location-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .category-section {
            margin-bottom: 1.5rem;
        }

        .category-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
            text-align: center;
        }

        .category-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .category-btn {
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            font-size: 0.9rem;
        }

        .category-btn:hover {
            border-color: #667eea;
            background: #f8fafc;
            transform: translateY(-2px);
        }

        .category-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .results-section {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .results-header {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-count {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .view-btn:first-child {
            border-radius: 8px 0 0 8px;
        }

        .view-btn:last-child {
            border-radius: 0 8px 8px 0;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .content-container {
            display: flex;
            min-height: 600px;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 600px;
        }

        .business-grid {
            flex: 1;
            max-height: 600px;
            overflow-y: auto;
            padding: 1rem;
        }

        .business-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .business-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .business-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .business-info h3 {
            font-size: 1.2rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .business-address {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .business-distance {
            color: #059669;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .business-rating {
            text-align: right;
        }

        .rating-stars {
            color: #fbbf24;
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .rating-text {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .business-tags {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .business-tag {
            background: #e5e7eb;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #374151;
        }

        .business-tag.brand {
            background: #dbeafe;
            color: #1e40af;
        }

        .business-tag.category {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .business-actions {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .rate-btn {
            background: #10b981;
            color: white;
        }

        .rate-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .directions-btn {
            background: #3b82f6;
            color: white;
        }

        .directions-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .business-owner-cta {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .business-owner-cta p {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .business-owner-cta button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .business-owner-cta button:hover {
            background: #5b21b6;
            transform: translateY(-1px);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            font-size: 1.1rem;
        }

        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            border: 1px solid #fecaca;
        }

        .success {
            background: #f0fdf4;
            color: #16a34a;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            border: 1px solid #bbf7d0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .footer {
            background: #1f2937;
            color: white;
            padding: 3rem 2rem 2rem;
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .footer-text {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            color: #d1d5db;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .footer-link {
            color: #9ca3af;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-link:hover {
            color: white;
        }

        .footer-copyright {
            color: #6b7280;
            font-size: 0.9rem;
            border-top: 1px solid #374151;
            padding-top: 1rem;
        }

        .help-tooltip {
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            white-space: nowrap;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .help-tooltip.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .logo {
                width: 80px;
                height: 80px;
            }

            .logo-fallback {
                width: 80px;
                height: 80px;
                font-size: 2.5rem;
            }

            .app-title {
                font-size: 1.8rem;
            }

            .main-content {
                margin-top: 180px;
                padding: 1rem;
            }

            .search-controls {
                flex-direction: column;
            }

            .search-input {
                min-width: auto;
            }

            .content-container {
                flex-direction: column;
            }

            .business-grid {
                max-height: none;
            }

            .category-filters {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .footer-links {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="/home/ubuntu/upload/gtgotg_logo_primary-BE-ZRW_Y.png" alt="GTGOTG Logo" class="logo" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="logo-fallback" style="display: none;">üöΩ</div>
                <div>
                    <div class="app-title">GTGOTG</div>
                    <div class="app-subtitle">"Got To Go On The Go"</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="help-btn" onclick="toggleHelp()" title="Help & Tips">üí°</button>
                <button class="btn btn-secondary" onclick="openLoginModal()">Login</button>
                <button class="btn btn-primary" onclick="openSignupModal()">Sign Up</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Search Section -->
        <section class="search-section">
            <div class="search-header">
                <h1 class="search-title">Find Clean, Safe Restrooms</h1>
                <p class="search-subtitle">Search ANY business nationwide by name, city, state, or ZIP code</p>
            </div>
            
            <div class="search-controls">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="Search McDonald's, Starbucks, 90210, Denver CO, or any business/location...">
                <button class="location-btn" id="locationBtn" onclick="enableLocation()">
                    üìç Enable Location
                </button>
            </div>

            <div class="category-section">
                <div class="category-title">Find Restrooms at ALL Types of Businesses</div>
                <div class="category-filters">
                    <button class="category-btn active" onclick="filterByCategory('')">All Businesses</button>
                    <button class="category-btn" onclick="filterByCategory('restaurant')">Restaurants</button>
                    <button class="category-btn" onclick="filterByCategory('fast_food')">Fast Food</button>
                    <button class="category-btn" onclick="filterByCategory('cafe')">Coffee Shops</button>
                    <button class="category-btn" onclick="filterByCategory('fuel')">Gas Stations</button>
                    <button class="category-btn" onclick="filterByCategory('convenience')">Convenience</button>
                    <button class="category-btn" onclick="filterByCategory('supermarket')">Supermarkets</button>
                    <button class="category-btn" onclick="filterByCategory('shopping')">Shopping</button>
                    <button class="category-btn" onclick="filterByCategory('hotel')">Hotels</button>
                    <button class="category-btn" onclick="filterByCategory('entertainment')">Entertainment</button>
                    <button class="category-btn" onclick="filterByCategory('healthcare')">Healthcare</button>
                    <button class="category-btn" onclick="filterByCategory('services')">Services</button>
                    <button class="category-btn" onclick="filterByCategory('truck_stop')">Truck Stops</button>
                    <button class="category-btn" onclick="filterByCategory('rest_area')">Rest Areas</button>
                    <button class="category-btn" onclick="filterByCategory('recreation')">Recreation</button>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Ready to search nationwide</div>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('split')">Map + List</button>
                    <button class="view-btn" onclick="switchView('map')">Map Only</button>
                    <button class="view-btn" onclick="switchView('list')">List Only</button>
                </div>
            </div>
            
            <div class="content-container" id="contentContainer">
                <div class="map-container" id="mapContainer">
                    <div id="map"></div>
                </div>
                <div class="business-grid" id="businessGrid">
                    <div class="loading">Enter any business name, city, state, or ZIP code to find restrooms nationwide</div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p class="footer-text">Real people reviewing restrooms at ALL types of businesses to help you find clean, safe facilities wherever you are in the USA</p>
            <div class="footer-links">
                <a href="#" class="footer-link" onclick="openModal('aboutModal')">About</a>
                <a href="#" class="footer-link" onclick="openModal('privacyModal')">Privacy Policy</a>
                <a href="#" class="footer-link" onclick="openModal('termsModal')">Terms of Service</a>
                <a href="#" class="footer-link" onclick="openModal('contactModal')">Contact</a>
                <a href="#" class="footer-link" onclick="openModal('helpModal')">Help</a>
            </div>
            <div class="footer-copyright">
                ¬© 2025 Jessica Esposito / Colorado Quality LLC. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Login to GTGOTG</h2>
                <button class="close-btn" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Admin Dashboard</h2>
                <button class="close-btn" onclick="closeModal('adminModal')">&times;</button>
            </div>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showAdminSection('users')">Manage Users</button>
                <button class="btn btn-primary" onclick="showAdminSection('businesses')">Manage Businesses</button>
                <button class="btn btn-primary" onclick="showAdminSection('reviews')">Moderate Reviews</button>
                <button class="btn btn-primary" onclick="showAdminSection('analytics')">Analytics</button>
            </div>
            <div id="adminSectionContent">
                <p>Select a section to manage.</p>
            </div>
        </div>
    </div>

    <!-- Help Tooltip -->
    <div class="help-tooltip" id="helpTooltip"></div>

    <!-- Leaflet JavaScript for OpenStreetMap -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Global variables
        let map;
        let userLocation = null;
        let currentUser = null;
        let businesses = [];
        let markers = [];
        let currentCategory = '';
        let currentView = 'split';
        let searchAttempts = 0;
        let helpMode = false;

        // Admin credentials
        const ADMIN_CREDENTIALS = {
            username: 'Adminjess',
            password: 'Alainajade1!'
        };

        // US ZIP code to state mapping for enhanced searches
        const ZIP_TO_STATE = {
            // Major ZIP code prefixes to state mapping
            '0': 'massachusetts', '1': 'massachusetts', '2': 'massachusetts',
            '3': 'new hampshire', '4': 'maine', '5': 'vermont',
            '6': 'connecticut', '7': 'new jersey', '8': 'new jersey',
            '9': 'new jersey', '10': 'new york', '11': 'new york',
            '12': 'new york', '13': 'new york', '14': 'new york',
            '15': 'pennsylvania', '16': 'pennsylvania', '17': 'pennsylvania',
            '18': 'pennsylvania', '19': 'pennsylvania', '20': 'maryland',
            '21': 'maryland', '22': 'virginia', '23': 'virginia',
            '24': 'virginia', '25': 'massachusetts', '26': 'massachusetts',
            '27': 'maryland', '28': 'south carolina', '29': 'south carolina',
            '30': 'georgia', '31': 'georgia', '32': 'florida',
            '33': 'florida', '34': 'florida', '35': 'alabama',
            '36': 'alabama', '37': 'north carolina', '38': 'north carolina',
            '39': 'ohio', '40': 'kentucky', '41': 'kentucky',
            '42': 'pennsylvania', '43': 'ohio', '44': 'ohio',
            '45': 'ohio', '46': 'indiana', '47': 'indiana',
            '48': 'michigan', '49': 'michigan', '50': 'iowa',
            '51': 'iowa', '52': 'iowa', '53': 'wisconsin',
            '54': 'wisconsin', '55': 'minnesota', '56': 'minnesota',
            '57': 'minnesota', '58': 'minnesota', '59': 'illinois',
            '60': 'illinois', '61': 'illinois', '62': 'illinois',
            '63': 'missouri', '64': 'missouri', '65': 'missouri',
            '66': 'kansas', '67': 'kansas', '68': 'nebraska',
            '69': 'nebraska', '70': 'louisiana', '71': 'louisiana',
            '72': 'arkansas', '73': 'oklahoma', '74': 'oklahoma',
            '75': 'texas', '76': 'texas', '77': 'texas',
            '78': 'texas', '79': 'texas', '80': 'colorado',
            '81': 'colorado', '82': 'wyoming', '83': 'idaho',
            '84': 'utah', '85': 'arizona', '86': 'arizona',
            '87': 'new mexico', '88': 'new mexico', '89': 'nevada',
            '90': 'california', '91': 'california', '92': 'california',
            '93': 'california', '94': 'california', '95': 'california',
            '96': 'california', '97': 'oregon', '98': 'washington',
            '99': 'alaska'
        };

        // US State bounding boxes for comprehensive searches
        const US_STATE_BOUNDS = {
            'colorado': [36.9929, -109.0452, 41.0023, -102.0415],
            'california': [32.5343, -124.4096, 42.0095, -114.1312],
            'texas': [25.8371, -106.6456, 36.5007, -93.5083],
            'florida': [24.3963, -87.6349, 31.0009, -79.9743],
            'new york': [40.4774, -79.7624, 45.0153, -71.7774],
            'illinois': [36.9703, -91.5130, 42.5083, -87.0199],
            'pennsylvania': [39.7198, -80.5190, 42.2694, -74.6895],
            'ohio': [38.4031, -84.8203, 41.9773, -80.5190],
            'georgia': [30.3557, -85.6051, 35.0008, -80.8414],
            'north carolina': [33.7514, -84.3218, 36.5881, -75.4001],
            'michigan': [41.6960, -90.4181, 48.2388, -82.1220],
            'new jersey': [38.9284, -75.5594, 41.3574, -73.8937],
            'virginia': [36.5407, -83.6753, 39.4660, -75.2420],
            'washington': [45.5435, -124.8489, 49.0024, -116.9155],
            'arizona': [31.3322, -114.8165, 37.0043, -109.0452],
            'massachusetts': [41.2376, -73.5081, 42.8868, -69.9286],
            'tennessee': [34.9829, -90.3103, 36.6782, -81.6469],
            'indiana': [37.7554, -88.0157, 41.7606, -84.7845],
            'missouri': [35.9957, -95.7742, 40.6136, -89.0993],
            'maryland': [37.9118, -79.4877, 39.7238, -75.0490],
            'wisconsin': [42.4919, -92.8892, 47.0803, -86.2490],
            'minnesota': [43.4993, -97.2394, 49.3844, -89.4836],
            'louisiana': [28.9285, -94.0431, 33.0197, -88.8175],
            'alabama': [30.2226, -88.4731, 35.0081, -84.8890],
            'kentucky': [36.4970, -89.5715, 39.1472, -81.9649],
            'oregon': [41.9918, -124.7035, 46.2991, -116.4635],
            'oklahoma': [33.6160, -103.0025, 37.0020, -94.4312],
            'connecticut': [40.9509, -73.7277, 42.0508, -71.7869],
            'utah': [36.9979, -114.0524, 42.0013, -109.0452],
            'iowa': [40.3756, -96.6397, 43.5012, -90.1401],
            'nevada': [35.0018, -120.0064, 42.0022, -114.0396],
            'arkansas': [33.0041, -94.6178, 36.4996, -89.6444],
            'mississippi': [30.1734, -91.6550, 34.9961, -88.0977],
            'kansas': [36.9930, -102.0517, 40.0030, -94.5882],
            'new mexico': [31.3323, -109.0501, 37.0002, -103.0020],
            'nebraska': [39.9999, -104.0537, 43.0017, -95.3080],
            'west virginia': [37.2014, -82.6447, 40.6381, -77.7190],
            'idaho': [41.9880, -117.2430, 49.0011, -111.0435],
            'hawaii': [18.9117, -178.4348, 28.4025, -154.8056],
            'new hampshire': [42.6970, -72.5570, 45.3058, -70.6104],
            'maine': [43.0642, -71.0840, 47.4598, -66.9851],
            'montana': [44.3583, -116.0489, 49.0011, -104.0395],
            'rhode island': [41.1460, -71.8620, 42.0188, -71.1208],
            'delaware': [38.4511, -75.7890, 39.8394, -75.0490],
            'south dakota': [42.4798, -104.0578, 45.9454, -96.4364],
            'north dakota': [45.9350, -104.0489, 49.0011, -96.5544],
            'alaska': [51.2097, -179.1506, 71.4410, -129.9795],
            'vermont': [42.7269, -73.4544, 45.0167, -71.4653],
            'wyoming': [40.9979, -111.0567, 45.0018, -104.0522],
            'south carolina': [32.0346, -83.3532, 35.2155, -78.4993]
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöΩ GTGOTG - "Got To Go On The Go" - Ultimate Nationwide Business Search Initializing...');
            initializeMap();
            setupEventListeners();
            console.log('‚úÖ GTGOTG - Ultimate nationwide application initialized successfully!');
        });

        // Initialize the map
        function initializeMap() {
            try {
                // Initialize map centered on the center of the USA
                map = L.map('map').setView([39.8283, -98.5795], 4);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                console.log('‚úÖ Map initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing map:', error);
                document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; color: #6b7280;">Map temporarily unavailable. Please try refreshing the page.</div>';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            
            // Search on Enter key
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Search as user types (debounced)
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (searchInput.value.length >= 3) {
                        performSearch();
                    }
                }, 1500);
            });
        }

        // Perform comprehensive nationwide search
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query && !userLocation) {
                showError('Please enter a search term or enable location');
                return;
            }

            // Parse the search query for comprehensive business search
            const parsedQuery = parseComprehensiveQuery(query);
            console.log('üîç Parsed comprehensive query:', parsedQuery);

            await searchAllBusinesses(parsedQuery, userLocation?.lat, userLocation?.lng, currentCategory);
        }

        // Parse search query for comprehensive business and location detection
        function parseComprehensiveQuery(query) {
            if (!query) return { businessName: '', location: '', zipCode: '', original: '' };

            // Check for ZIP code pattern
            const zipCodeMatch = query.match(/\b\d{5}(-\d{4})?\b/);
            let zipCode = zipCodeMatch ? zipCodeMatch[0] : '';

            // Common business chains and keywords
            const businessKeywords = [
                'mcdonalds', 'mcdonald', 'burger king', 'subway', 'starbucks', 'dunkin', 'taco bell', 'kfc', 'pizza hut', 'dominos', 'papa johns',
                'walmart', 'target', 'costco', 'home depot', 'lowes', 'best buy', 'cvs', 'walgreens', 'rite aid',
                'shell', 'exxon', 'bp', 'chevron', 'mobil', 'texaco', 'citgo', 'sunoco', 'marathon', 'speedway',
                '7-eleven', 'circle k', 'wawa', 'sheetz', 'casey', 'pilot', 'flying j', 'loves', 'ta', 'petro',
                'marriott', 'hilton', 'holiday inn', 'hampton inn', 'comfort inn', 'best western', 'motel 6',
                'applebees', 'olive garden', 'red lobster', 'outback', 'chilis', 'tgi friday', 'dennys', 'ihop',
                'panera', 'chipotle', 'qdoba', 'five guys', 'in-n-out', 'whataburger', 'sonic', 'dairy queen'
            ];

            // Location keywords (states, major cities)
            const locationKeywords = [
                'alabama', 'alaska', 'arizona', 'arkansas', 'california', 'colorado', 'connecticut', 'delaware', 'florida', 'georgia',
                'hawaii', 'idaho', 'illinois', 'indiana', 'iowa', 'kansas', 'kentucky', 'louisiana', 'maine', 'maryland',
                'massachusetts', 'michigan', 'minnesota', 'mississippi', 'missouri', 'montana', 'nebraska', 'nevada',
                'new hampshire', 'new jersey', 'new mexico', 'new york', 'north carolina', 'north dakota', 'ohio',
                'oklahoma', 'oregon', 'pennsylvania', 'rhode island', 'south carolina', 'south dakota', 'tennessee',
                'texas', 'utah', 'vermont', 'virginia', 'washington', 'west virginia', 'wisconsin', 'wyoming',
                'al', 'ak', 'az', 'ar', 'ca', 'co', 'ct', 'de', 'fl', 'ga', 'hi', 'id', 'il', 'in', 'ia', 'ks',
                'ky', 'la', 'me', 'md', 'ma', 'mi', 'mn', 'ms', 'mo', 'mt', 'ne', 'nv', 'nh', 'nj', 'nm', 'ny',
                'nc', 'nd', 'oh', 'ok', 'or', 'pa', 'ri', 'sc', 'sd', 'tn', 'tx', 'ut', 'vt', 'va', 'wa', 'wv', 'wi', 'wy',
                'new york city', 'los angeles', 'chicago', 'houston', 'phoenix', 'philadelphia', 'san antonio', 'san diego',
                'dallas', 'san jose', 'austin', 'jacksonville', 'fort worth', 'columbus', 'charlotte', 'san francisco',
                'indianapolis', 'seattle', 'denver', 'washington', 'boston', 'el paso', 'detroit', 'nashville', 'portland',
                'memphis', 'oklahoma city', 'las vegas', 'louisville', 'baltimore', 'milwaukee', 'albuquerque', 'tucson',
                'fresno', 'sacramento', 'mesa', 'kansas city', 'atlanta', 'long beach', 'colorado springs', 'raleigh',
                'miami', 'virginia beach', 'omaha', 'oakland', 'minneapolis', 'tulsa', 'arlington', 'tampa', 'new orleans'
            ];

            const words = query.toLowerCase().split(/[\s,]+/);
            let businessName = '';
            let location = '';

            // Try to identify business name
            for (const keyword of businessKeywords) {
                if (words.some(word => word.includes(keyword))) {
                    businessName = keyword === 'mcdonald' ? 'McDonald\'s' : 
                                  keyword === 'mcdonalds' ? 'McDonald\'s' :
                                  keyword === 'burger king' ? 'Burger King' :
                                  keyword === 'taco bell' ? 'Taco Bell' :
                                  keyword === 'pizza hut' ? 'Pizza Hut' :
                                  keyword === 'papa johns' ? 'Papa John\'s' :
                                  keyword === 'home depot' ? 'Home Depot' :
                                  keyword === 'best buy' ? 'Best Buy' :
                                  keyword === 'rite aid' ? 'Rite Aid' :
                                  keyword === '7-eleven' ? '7-Eleven' :
                                  keyword === 'circle k' ? 'Circle K' :
                                  keyword === 'flying j' ? 'Flying J' :
                                  keyword === 'holiday inn' ? 'Holiday Inn' :
                                  keyword === 'hampton inn' ? 'Hampton Inn' :
                                  keyword === 'comfort inn' ? 'Comfort Inn' :
                                  keyword === 'best western' ? 'Best Western' :
                                  keyword === 'motel 6' ? 'Motel 6' :
                                  keyword === 'olive garden' ? 'Olive Garden' :
                                  keyword === 'red lobster' ? 'Red Lobster' :
                                  keyword === 'tgi friday' ? 'TGI Friday\'s' :
                                  keyword === 'dairy queen' ? 'Dairy Queen' :
                                  keyword.charAt(0).toUpperCase() + keyword.slice(1);
                    break;
                }
            }

            // If we found a business name, the rest is likely location
            if (businessName) {
                const businessWords = businessName.toLowerCase().split(/[\s']+/);
                const locationWords = words.filter(word => 
                    !businessWords.some(bw => word.includes(bw.replace(/[^a-z]/g, '')))
                );
                location = locationWords.join(' ');
            } else {
                // Check if it looks like a location
                const hasLocationKeyword = locationKeywords.some(keyword => 
                    words.some(word => word.includes(keyword))
                );

                if (zipCode || hasLocationKeyword || words.length <= 3) {
                    location = query;
                } else {
                    // Assume it's a business name if it doesn't look like a location
                    businessName = query;
                }
            }

            return {
                businessName: businessName.trim(),
                location: location.trim(),
                zipCode: zipCode,
                original: query
            };
        }

        // Search all types of businesses nationwide
        async function searchAllBusinesses(parsedQuery, userLat = null, userLng = null, category = '') {
            try {
                console.log('üîç Comprehensive nationwide business search:', parsedQuery, 'Category:', category, 'Location:', userLat, userLng);
                
                // Show loading state
                document.getElementById('businessGrid').innerHTML = '<div class="loading">üîç Searching ALL businesses nationwide...</div>';
                document.getElementById('resultsCount').textContent = 'Searching...';

                let searchBounds = null;
                let searchCenter = null;

                // Determine search area with enhanced ZIP code support
                if (userLat && userLng) {
                    searchCenter = { lat: userLat, lng: userLng };
                    searchBounds = calculateBounds(userLat, userLng, 25000); // 25km radius for user location
                } else if (parsedQuery.zipCode) {
                    // Handle ZIP code searches
                    const zipPrefix = parsedQuery.zipCode.substring(0, 2);
                    const stateName = ZIP_TO_STATE[zipPrefix] || ZIP_TO_STATE[parsedQuery.zipCode.substring(0, 1)];
                    if (stateName) {
                        searchBounds = US_STATE_BOUNDS[stateName];
                        if (searchBounds) {
                            const centerLat = (searchBounds[0] + searchBounds[2]) / 2;
                            const centerLng = (searchBounds[1] + searchBounds[3]) / 2;
                            map.setView([centerLat, centerLng], 8);
                        }
                    }
                    // Also try geocoding the ZIP code
                    if (!searchBounds) {
                        searchCenter = await geocodeLocation(parsedQuery.zipCode);
                        if (searchCenter) {
                            searchBounds = calculateBounds(searchCenter.lat, searchCenter.lng, 50000); // 50km radius for ZIP
                            map.setView([searchCenter.lat, searchCenter.lng], 10);
                        }
                    }
                } else if (parsedQuery.location) {
                    // Try to get state bounds first, then geocode
                    searchBounds = getStateBounds(parsedQuery.location);
                    if (!searchBounds) {
                        searchCenter = await geocodeLocation(parsedQuery.location);
                        if (searchCenter) {
                            searchBounds = calculateBounds(searchCenter.lat, searchCenter.lng, 100000); // 100km radius
                            map.setView([searchCenter.lat, searchCenter.lng], 8);
                        }
                    } else {
                        // Center map on state
                        const centerLat = (searchBounds[0] + searchBounds[2]) / 2;
                        const centerLng = (searchBounds[1] + searchBounds[3]) / 2;
                        map.setView([centerLat, centerLng], 7);
                    }
                }

                // Try multiple comprehensive search strategies for ALL business types
                let results = [];
                searchAttempts = 0;

                // Strategy 1: Comprehensive business search across all categories
                if (searchBounds) {
                    results = await trySearch(() => buildComprehensiveBusinessQuery(searchBounds, category, parsedQuery.businessName));
                }

                // Strategy 2: Brand-specific search if business name provided
                if (results.length < 20 && parsedQuery.businessName && searchBounds) {
                    results = results.concat(await trySearch(() => buildBrandSearchQuery(searchBounds, parsedQuery.businessName)));
                }

                // Strategy 3: Category-specific search if category selected
                if (results.length < 10 && category && searchBounds) {
                    results = results.concat(await trySearch(() => buildCategorySearchQuery(searchBounds, category)));
                }

                // Strategy 4: Fallback to comprehensive sample data
                if (results.length === 0) {
                    console.log('üîÑ Using comprehensive sample business data');
                    results = generateComprehensiveSampleBusinesses(searchCenter, parsedQuery.location, parsedQuery.businessName, category);
                }

                // Remove duplicates and limit results
                const uniqueResults = removeDuplicateBusinesses(results);
                businesses = uniqueResults.slice(0, 300); // Increased limit for comprehensive coverage
                
                renderBusinesses();
                addMarkersToMap();
                updateResultsCount();

                console.log(`‚úÖ Found ${businesses.length} businesses (${uniqueResults.length} unique from ${results.length} total)`);

            } catch (error) {
                console.error('‚ùå Error searching businesses:', error);
                handleSearchError(error);
            }
        }

        // Build comprehensive business query for ALL types of businesses
        function buildComprehensiveBusinessQuery(bounds, category, businessName) {
            const bbox = `(bbox:${bounds[0]},${bounds[1]},${bounds[2]},${bounds[3]})`;
            
            let queries = [];
            
            // All major business categories that have restrooms
            const businessCategories = {
                'restaurant': 'nwr["amenity"="restaurant"]',
                'fast_food': 'nwr["amenity"="fast_food"]',
                'cafe': 'nwr["amenity"="cafe"]',
                'fuel': 'nwr["amenity"="fuel"]',
                'convenience': 'nwr["shop"="convenience"]',
                'supermarket': 'nwr["shop"="supermarket"]',
                'shopping': 'nwr["shop"~"^(mall|department_store|clothes|shoes|electronics|furniture|hardware|books|toys|sports|jewelry|beauty|pharmacy)$"]',
                'hotel': 'nwr["tourism"="hotel"]',
                'entertainment': 'nwr["amenity"~"^(cinema|theatre|nightclub|bar|pub|casino)$"]',
                'healthcare': 'nwr["amenity"~"^(hospital|clinic|dentist|pharmacy|veterinary)$"]',
                'services': 'nwr["amenity"~"^(bank|post_office|library|police|fire_station|courthouse|townhall)$"]',
                'truck_stop': 'nwr["highway"="services"]',
                'rest_area': 'nwr["highway"="rest_area"]',
                'recreation': 'nwr["leisure"~"^(park|sports_centre|swimming_pool|golf_course|stadium|fitness_centre)$"]'
            };

            if (category && businessCategories[category]) {
                queries.push(`${businessCategories[category]}${bbox};`);
            } else if (!category) {
                // Include all major categories for comprehensive search
                queries.push(`nwr["amenity"~"^(restaurant|fast_food|cafe|fuel|bar|pub|cinema|hospital|bank|pharmacy)$"]${bbox};`);
                queries.push(`nwr["shop"~"^(convenience|supermarket|mall|department_store|clothes|pharmacy)$"]${bbox};`);
                queries.push(`nwr["tourism"="hotel"]${bbox};`);
                queries.push(`nwr["highway"~"^(services|rest_area)$"]${bbox};`);
                queries.push(`nwr["leisure"~"^(park|sports_centre|swimming_pool|stadium)$"]${bbox};`);
            }
            
            // Add business name filter if specified
            if (businessName) {
                const escapedName = businessName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                queries = queries.map(query => query.replace(bbox, `["name"~"${escapedName}",i]${bbox}`));
            }
            
            return `
                [out:json][timeout:25];
                (
                  ${queries.join('\n  ')}
                );
                out center meta 400;
            `;
        }

        // Build brand-specific search query
        function buildBrandSearchQuery(bounds, businessName) {
            const bbox = bounds ? `(bbox:${bounds[0]},${bounds[1]},${bounds[2]},${bounds[3]})` : '';
            const escapedName = businessName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            return `
                [out:json][timeout:25];
                (
                  // Search by name across all business types
                  nwr["name"~"${escapedName}",i]${bbox};
                  
                  // Search by brand
                  nwr["brand"~"${escapedName}",i]${bbox};
                  
                  // Search by operator
                  nwr["operator"~"${escapedName}",i]${bbox};
                );
                out center meta 200;
            `;
        }

        // Build category-specific search query
        function buildCategorySearchQuery(bounds, category) {
            const bbox = bounds ? `(bbox:${bounds[0]},${bounds[1]},${bounds[2]},${bounds[3]})` : '';
            
            const categoryQueries = {
                'restaurant': 'nwr["amenity"="restaurant"]',
                'fast_food': 'nwr["amenity"="fast_food"]',
                'cafe': 'nwr["amenity"="cafe"]',
                'fuel': 'nwr["amenity"="fuel"]',
                'convenience': 'nwr["shop"="convenience"]',
                'supermarket': 'nwr["shop"="supermarket"]',
                'shopping': 'nwr["shop"~"^(mall|department_store|clothes|shoes|electronics)$"]',
                'hotel': 'nwr["tourism"="hotel"]',
                'entertainment': 'nwr["amenity"~"^(cinema|theatre|nightclub|bar|pub)$"]',
                'healthcare': 'nwr["amenity"~"^(hospital|clinic|dentist|pharmacy)$"]',
                'services': 'nwr["amenity"~"^(bank|post_office|library|police)$"]',
                'truck_stop': 'nwr["highway"="services"]',
                'rest_area': 'nwr["highway"="rest_area"]',
                'recreation': 'nwr["leisure"~"^(park|sports_centre|swimming_pool|stadium)$"]'
            };

            const query = categoryQueries[category] || 'nwr["amenity"]';
            
            return `
                [out:json][timeout:25];
                (
                  ${query}${bbox};
                );
                out center meta 300;
            `;
        }

        // Generate comprehensive sample businesses for all categories
        function generateComprehensiveSampleBusinesses(searchCenter, location, businessName, category) {
            const sampleBusinesses = [
                // Fast Food Chains
                { name: 'McDonald\'s', category: 'fast_food', brand: 'McDonald\'s', type: 'Fast Food' },
                { name: 'Burger King', category: 'fast_food', brand: 'Burger King', type: 'Fast Food' },
                { name: 'Subway', category: 'fast_food', brand: 'Subway', type: 'Fast Food' },
                { name: 'Taco Bell', category: 'fast_food', brand: 'Taco Bell', type: 'Fast Food' },
                { name: 'KFC', category: 'fast_food', brand: 'KFC', type: 'Fast Food' },
                { name: 'Pizza Hut', category: 'fast_food', brand: 'Pizza Hut', type: 'Fast Food' },
                { name: 'Domino\'s Pizza', category: 'fast_food', brand: 'Domino\'s', type: 'Fast Food' },
                { name: 'Wendy\'s', category: 'fast_food', brand: 'Wendy\'s', type: 'Fast Food' },
                { name: 'Chipotle Mexican Grill', category: 'fast_food', brand: 'Chipotle', type: 'Fast Food' },
                { name: 'Five Guys', category: 'fast_food', brand: 'Five Guys', type: 'Fast Food' },

                // Coffee Shops
                { name: 'Starbucks', category: 'cafe', brand: 'Starbucks', type: 'Coffee Shop' },
                { name: 'Dunkin\'', category: 'cafe', brand: 'Dunkin\'', type: 'Coffee Shop' },
                { name: 'Panera Bread', category: 'cafe', brand: 'Panera', type: 'Coffee Shop' },
                { name: 'Tim Hortons', category: 'cafe', brand: 'Tim Hortons', type: 'Coffee Shop' },

                // Restaurants
                { name: 'Applebee\'s', category: 'restaurant', brand: 'Applebee\'s', type: 'Restaurant' },
                { name: 'Olive Garden', category: 'restaurant', brand: 'Olive Garden', type: 'Restaurant' },
                { name: 'Red Lobster', category: 'restaurant', brand: 'Red Lobster', type: 'Restaurant' },
                { name: 'Outback Steakhouse', category: 'restaurant', brand: 'Outback', type: 'Restaurant' },
                { name: 'Chili\'s Grill & Bar', category: 'restaurant', brand: 'Chili\'s', type: 'Restaurant' },
                { name: 'TGI Friday\'s', category: 'restaurant', brand: 'TGI Friday\'s', type: 'Restaurant' },
                { name: 'Denny\'s', category: 'restaurant', brand: 'Denny\'s', type: 'Restaurant' },
                { name: 'IHOP', category: 'restaurant', brand: 'IHOP', type: 'Restaurant' },

                // Gas Stations
                { name: 'Shell Gas Station', category: 'fuel', brand: 'Shell', type: 'Gas Station' },
                { name: 'Exxon Mobil', category: 'fuel', brand: 'Exxon', type: 'Gas Station' },
                { name: 'Chevron', category: 'fuel', brand: 'Chevron', type: 'Gas Station' },
                { name: 'BP Gas Station', category: 'fuel', brand: 'BP', type: 'Gas Station' },
                { name: 'Speedway', category: 'fuel', brand: 'Speedway', type: 'Gas Station' },
                { name: 'Marathon Gas', category: 'fuel', brand: 'Marathon', type: 'Gas Station' },

                // Convenience Stores
                { name: '7-Eleven', category: 'convenience', brand: '7-Eleven', type: 'Convenience Store' },
                { name: 'Circle K', category: 'convenience', brand: 'Circle K', type: 'Convenience Store' },
                { name: 'Wawa', category: 'convenience', brand: 'Wawa', type: 'Convenience Store' },
                { name: 'Sheetz', category: 'convenience', brand: 'Sheetz', type: 'Convenience Store' },

                // Supermarkets
                { name: 'Walmart Supercenter', category: 'supermarket', brand: 'Walmart', type: 'Supermarket' },
                { name: 'Target', category: 'supermarket', brand: 'Target', type: 'Supermarket' },
                { name: 'Kroger', category: 'supermarket', brand: 'Kroger', type: 'Supermarket' },
                { name: 'Safeway', category: 'supermarket', brand: 'Safeway', type: 'Supermarket' },
                { name: 'Publix', category: 'supermarket', brand: 'Publix', type: 'Supermarket' },

                // Shopping
                { name: 'Best Buy', category: 'shopping', brand: 'Best Buy', type: 'Electronics Store' },
                { name: 'Home Depot', category: 'shopping', brand: 'Home Depot', type: 'Hardware Store' },
                { name: 'Lowe\'s', category: 'shopping', brand: 'Lowe\'s', type: 'Hardware Store' },
                { name: 'Costco Wholesale', category: 'shopping', brand: 'Costco', type: 'Warehouse Store' },

                // Hotels
                { name: 'Holiday Inn Express', category: 'hotel', brand: 'Holiday Inn', type: 'Hotel' },
                { name: 'Hampton Inn', category: 'hotel', brand: 'Hampton Inn', type: 'Hotel' },
                { name: 'Marriott Hotel', category: 'hotel', brand: 'Marriott', type: 'Hotel' },
                { name: 'Hilton Hotel', category: 'hotel', brand: 'Hilton', type: 'Hotel' },
                { name: 'Comfort Inn', category: 'hotel', brand: 'Comfort Inn', type: 'Hotel' },

                // Entertainment
                { name: 'AMC Theatres', category: 'entertainment', brand: 'AMC', type: 'Movie Theater' },
                { name: 'Regal Cinemas', category: 'entertainment', brand: 'Regal', type: 'Movie Theater' },
                { name: 'Dave & Buster\'s', category: 'entertainment', brand: 'Dave & Buster\'s', type: 'Entertainment' },

                // Healthcare
                { name: 'CVS Pharmacy', category: 'healthcare', brand: 'CVS', type: 'Pharmacy' },
                { name: 'Walgreens', category: 'healthcare', brand: 'Walgreens', type: 'Pharmacy' },
                { name: 'Rite Aid', category: 'healthcare', brand: 'Rite Aid', type: 'Pharmacy' },

                // Services
                { name: 'Bank of America', category: 'services', brand: 'Bank of America', type: 'Bank' },
                { name: 'Wells Fargo', category: 'services', brand: 'Wells Fargo', type: 'Bank' },
                { name: 'Chase Bank', category: 'services', brand: 'Chase', type: 'Bank' },

                // Truck Stops
                { name: 'Pilot Travel Center', category: 'truck_stop', brand: 'Pilot', type: 'Truck Stop' },
                { name: 'Flying J Travel Plaza', category: 'truck_stop', brand: 'Flying J', type: 'Truck Stop' },
                { name: 'Love\'s Travel Stop', category: 'truck_stop', brand: 'Love\'s', type: 'Truck Stop' },
                { name: 'TA Travel Center', category: 'truck_stop', brand: 'TA', type: 'Truck Stop' },

                // Rest Areas
                { name: 'Interstate Rest Area', category: 'rest_area', brand: '', type: 'Rest Area' },
                { name: 'Highway Welcome Center', category: 'rest_area', brand: '', type: 'Rest Area' },

                // Recreation
                { name: 'Planet Fitness', category: 'recreation', brand: 'Planet Fitness', type: 'Gym' },
                { name: 'LA Fitness', category: 'recreation', brand: 'LA Fitness', type: 'Gym' },
                { name: 'City Park', category: 'recreation', brand: '', type: 'Park' }
            ];

            const baseLat = searchCenter ? searchCenter.lat : 39.8283;
            const baseLng = searchCenter ? searchCenter.lng : -98.5795;
            const locationName = location || 'USA';

            // Filter by business name if specified
            let filteredBusinesses = sampleBusinesses;
            if (businessName) {
                filteredBusinesses = sampleBusinesses.filter(business => 
                    business.name.toLowerCase().includes(businessName.toLowerCase()) ||
                    business.brand.toLowerCase().includes(businessName.toLowerCase())
                );
            }

            // Filter by category if specified
            if (category) {
                filteredBusinesses = filteredBusinesses.filter(business => business.category === category);
            }

            // If no matches, return all businesses
            if (filteredBusinesses.length === 0) {
                filteredBusinesses = sampleBusinesses;
            }

            return filteredBusinesses.map((business, index) => ({
                id: `sample_${index}`,
                name: business.name,
                address: `${1000 + index * 100} Main Street, ${locationName}`,
                lat: baseLat + (Math.random() - 0.5) * 4, // Spread over larger area
                lng: baseLng + (Math.random() - 0.5) * 4,
                category: business.category,
                brand: business.brand,
                type: business.type,
                phone: `(555) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
                website: business.brand ? `https://www.${business.brand.toLowerCase().replace(/[^a-z]/g, '')}.com` : '',
                opening_hours: getBusinessHours(business.category),
                distance: searchCenter ? Math.random() * 50 + 1 : null,
                rating: generateRandomRating(),
                amenities: generateBusinessAmenities(business),
                hasRestroom: true
            }));
        }

        // Get typical business hours by category
        function getBusinessHours(category) {
            const hours = {
                'fast_food': 'Mon-Sun 6:00-23:00',
                'cafe': 'Mon-Sun 5:30-21:00',
                'restaurant': 'Mon-Sun 11:00-22:00',
                'fuel': '24/7',
                'convenience': '24/7',
                'supermarket': 'Mon-Sun 6:00-23:00',
                'shopping': 'Mon-Sun 9:00-21:00',
                'hotel': '24/7',
                'entertainment': 'Mon-Sun 10:00-24:00',
                'healthcare': 'Mon-Fri 8:00-18:00',
                'services': 'Mon-Fri 9:00-17:00',
                'truck_stop': '24/7',
                'rest_area': 'Always Open',
                'recreation': 'Mon-Sun 5:00-22:00'
            };
            return hours[category] || 'Mon-Sun 9:00-21:00';
        }

        // Generate business-specific amenities
        function generateBusinessAmenities(business) {
            const amenities = [];
            
            // Common restroom amenities
            if (Math.random() > 0.3) amenities.push('üöª Family Restroom');
            if (Math.random() > 0.4) amenities.push('‚ôø ADA Accessible');
            if (Math.random() > 0.5) amenities.push('üßª Paper Towels');
            if (Math.random() > 0.6) amenities.push('üßº Soap Dispenser');
            
            // Category-specific amenities
            switch (business.category) {
                case 'fast_food':
                case 'restaurant':
                    if (Math.random() > 0.4) amenities.push('üçΩÔ∏è Dining Area');
                    if (Math.random() > 0.6) amenities.push('üöó Drive-Thru');
                    if (Math.random() > 0.7) amenities.push('üì∂ Free WiFi');
                    break;
                case 'cafe':
                    amenities.push('‚òï Coffee');
                    if (Math.random() > 0.5) amenities.push('üì∂ Free WiFi');
                    if (Math.random() > 0.6) amenities.push('ü•ê Pastries');
                    break;
                case 'fuel':
                    if (Math.random() > 0.4) amenities.push('üöó Car Wash');
                    if (Math.random() > 0.6) amenities.push('üõí Convenience Store');
                    if (Math.random() > 0.7) amenities.push('üí® Air Pump');
                    break;
                case 'truck_stop':
                    amenities.push('üöõ Truck Parking');
                    amenities.push('‚õΩ Diesel Fuel');
                    if (Math.random() > 0.3) amenities.push('üöø Shower Facilities');
                    if (Math.random() > 0.4) amenities.push('üçî Food Court');
                    if (Math.random() > 0.5) amenities.push('üõí Convenience Store');
                    break;
                case 'rest_area':
                    amenities.push('üÖøÔ∏è Free Parking');
                    amenities.push('üóëÔ∏è Waste Disposal');
                    if (Math.random() > 0.4) amenities.push('üèì Picnic Tables');
                    if (Math.random() > 0.5) amenities.push('üêï Pet Area');
                    break;
                case 'hotel':
                    amenities.push('üõèÔ∏è Lodging');
                    if (Math.random() > 0.4) amenities.push('üÖøÔ∏è Parking');
                    if (Math.random() > 0.5) amenities.push('üì∂ Free WiFi');
                    if (Math.random() > 0.6) amenities.push('üèä Pool');
                    break;
                case 'supermarket':
                case 'shopping':
                    amenities.push('üõí Shopping');
                    if (Math.random() > 0.5) amenities.push('üÖøÔ∏è Parking');
                    if (Math.random() > 0.6) amenities.push('üõçÔ∏è Customer Service');
                    break;
            }
            
            return amenities;
        }

        // All other functions remain the same as in the previous version...
        // (Including: trySearch, processOverpassResults, geocodeLocation, etc.)

        // Try a search with error handling and retries
        async function trySearch(queryBuilder, maxRetries = 2) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    searchAttempts++;
                    const query = queryBuilder();
                    console.log(`üì° Comprehensive search attempt ${searchAttempts}:`, query.substring(0, 200) + '...');

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 25000); // 25 second timeout

                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `data=${encodeURIComponent(query)}`,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const processedResults = processOverpassResults(data.elements, null, null);
                    
                    console.log(`üìä Search attempt ${searchAttempts} returned ${processedResults.length} results`);
                    return processedResults;
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Search attempt ${attempt + 1} failed:`, error.message);
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            return [];
        }

        // Process Overpass API results with enhanced categorization
        function processOverpassResults(elements, userLat, userLng) {
            const processedBusinesses = [];
            const seenBusinesses = new Set();

            elements.forEach((element) => {
                if (!element.tags) return;

                const name = element.tags.name || generateDefaultName(element.tags);
                if (!name) return;

                let lat, lng;
                if (element.type === 'node') {
                    lat = element.lat;
                    lng = element.lon;
                } else if (element.center) {
                    lat = element.center.lat;
                    lng = element.center.lon;
                } else {
                    return;
                }

                const uniqueId = `${name}_${lat.toFixed(4)}_${lng.toFixed(4)}`;
                if (seenBusinesses.has(uniqueId)) return;
                seenBusinesses.add(uniqueId);

                let category = determineBusinessCategory(element.tags);
                let address = buildAddress(element.tags);
                let distance = null;
                if (userLat && userLng) {
                    distance = calculateDistance(userLat, userLng, lat, lng);
                }

                const business = {
                    id: `osm_${element.type}_${element.id}`,
                    name: name,
                    address: address,
                    lat: lat,
                    lng: lng,
                    category: category,
                    brand: element.tags.brand || element.tags.operator || '',
                    type: formatBusinessType(category),
                    phone: element.tags.phone || '',
                    website: element.tags.website || '',
                    opening_hours: element.tags.opening_hours || 'Hours not available',
                    distance: distance,
                    rating: generateRandomRating(),
                    amenities: generateBusinessAmenities({category: category}),
                    hasRestroom: true
                };

                processedBusinesses.push(business);
            });

            // Sort by distance if available, otherwise by name
            if (userLat && userLng) {
                processedBusinesses.sort((a, b) => (a.distance || 999) - (b.distance || 999));
            } else {
                processedBusinesses.sort((a, b) => a.name.localeCompare(b.name));
            }

            return processedBusinesses;
        }

        // Generate default name for unnamed facilities
        function generateDefaultName(tags) {
            if (tags.highway === 'services') {
                return tags.operator ? `${tags.operator} Travel Center` : 'Highway Service Area';
            } else if (tags.highway === 'rest_area') {
                return 'Highway Rest Area';
            } else if (tags.amenity === 'fuel') {
                return tags.brand ? `${tags.brand} Gas Station` : 'Gas Station';
            } else if (tags.shop) {
                return tags.brand ? `${tags.brand} Store` : `${tags.shop.charAt(0).toUpperCase() + tags.shop.slice(1)} Store`;
            }
            return null;
        }

        // Determine business category from OSM tags
        function determineBusinessCategory(tags) {
            if (tags.highway === 'services') return 'truck_stop';
            if (tags.highway === 'rest_area') return 'rest_area';
            if (tags.amenity === 'fuel') return 'fuel';
            if (tags.amenity === 'fast_food') return 'fast_food';
            if (tags.amenity === 'restaurant') return 'restaurant';
            if (tags.amenity === 'cafe') return 'cafe';
            if (tags.shop === 'convenience') return 'convenience';
            if (tags.shop === 'supermarket') return 'supermarket';
            if (tags.shop) return 'shopping';
            if (tags.tourism === 'hotel') return 'hotel';
            if (tags.amenity === 'cinema' || tags.amenity === 'theatre' || tags.amenity === 'nightclub') return 'entertainment';
            if (tags.amenity === 'hospital' || tags.amenity === 'clinic' || tags.amenity === 'pharmacy') return 'healthcare';
            if (tags.amenity === 'bank' || tags.amenity === 'post_office') return 'services';
            if (tags.leisure) return 'recreation';
            return 'other';
        }

        // Format business type for display
        function formatBusinessType(category) {
            const typeMap = {
                'restaurant': 'Restaurant',
                'fast_food': 'Fast Food',
                'cafe': 'Coffee Shop',
                'fuel': 'Gas Station',
                'convenience': 'Convenience Store',
                'supermarket': 'Supermarket',
                'shopping': 'Store',
                'hotel': 'Hotel',
                'entertainment': 'Entertainment',
                'healthcare': 'Healthcare',
                'services': 'Services',
                'truck_stop': 'Truck Stop',
                'rest_area': 'Rest Area',
                'recreation': 'Recreation',
                'other': 'Business'
            };
            return typeMap[category] || 'Business';
        }

        // Get state bounding box
        function getStateBounds(location) {
            const locationLower = location.toLowerCase();
            
            // Check for state names or abbreviations
            for (const [state, bounds] of Object.entries(US_STATE_BOUNDS)) {
                if (locationLower.includes(state) || 
                    locationLower.includes(state.replace(' ', '')) ||
                    (state === 'colorado' && locationLower.includes('co')) ||
                    (state === 'california' && locationLower.includes('ca')) ||
                    (state === 'texas' && locationLower.includes('tx')) ||
                    (state === 'florida' && locationLower.includes('fl')) ||
                    (state === 'new york' && locationLower.includes('ny'))) {
                    return bounds;
                }
            }
            return null;
        }

        // Calculate bounding box from center point and radius
        function calculateBounds(lat, lng, radiusMeters) {
            const latDelta = radiusMeters / 111000; // Approximate meters per degree latitude
            const lngDelta = radiusMeters / (111000 * Math.cos(lat * Math.PI / 180));
            
            return [
                lat - latDelta,  // south
                lng - lngDelta,  // west
                lat + latDelta,  // north
                lng + lngDelta   // east
            ];
        }

        // Geocode location using Nominatim
        async function geocodeLocation(query) {
            try {
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&limit=1`;
                const response = await fetch(nominatimUrl);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('‚ùå Geocoding error:', error);
                return null;
            }
        }

        // Build address from OSM tags
        function buildAddress(tags) {
            let address = '';
            if (tags['addr:housenumber'] && tags['addr:street']) {
                address += `${tags['addr:housenumber']} ${tags['addr:street']}, `;
            }
            if (tags['addr:city']) {
                address += `${tags['addr:city']}, `;
            }
            if (tags['addr:state']) {
                address += `${tags['addr:state']} `;
            }
            if (tags['addr:postcode']) {
                address += tags['addr:postcode'];
            }

            return address.trim() || 'Address not available';
        }

        // Generate placeholder rating
        function generateRandomRating() {
            return {
                overall: Math.floor(Math.random() * 4) + 7,
                cleanliness: Math.floor(Math.random() * 4) + 6,
                safety: Math.floor(Math.random() * 4) + 7,
                accessibility: Math.floor(Math.random() * 4) + 6,
                reviewCount: Math.floor(Math.random() * 50) + 5
            };
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Remove duplicate businesses
        function removeDuplicateBusinesses(businesses) {
            const seen = new Set();
            return businesses.filter(business => {
                const key = `${business.name}_${business.lat.toFixed(3)}_${business.lng.toFixed(3)}`;
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }

        // Render businesses in the grid
        function renderBusinesses() {
            const grid = document.getElementById('businessGrid');
            
            if (businesses.length === 0) {
                grid.innerHTML = '<div class="loading">No businesses found. Try a different search term or location.</div>';
                return;
            }

            grid.innerHTML = businesses.map(business => `
                <div class="business-card" onclick="openBusinessDetails('${business.id}')">
                    <div class="business-header">
                        <div class="business-info">
                            <h3>${business.name}</h3>
                            <div class="business-address">${business.address}</div>
                            ${business.distance ? `<div class="business-distance">${business.distance.toFixed(1)} miles away</div>` : ''}
                        </div>
                        <div class="business-rating">
                            <div class="rating-stars">${'‚≠ê'.repeat(Math.floor(business.rating.overall / 2))}</div>
                            <div class="rating-text">${business.rating.overall}/10 (${business.rating.reviewCount} reviews)</div>
                        </div>
                    </div>
                    
                    <div class="business-tags">
                        <span class="business-tag category">${business.type}</span>
                        ${business.brand ? `<span class="business-tag brand">${business.brand}</span>` : ''}
                        <span class="business-tag">üöª Has Restrooms</span>
                    </div>
                    
                    <div style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                        ${business.opening_hours}
                    </div>
                    
                    ${business.amenities.length > 0 ? `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem;">Amenities:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; font-size: 0.75rem;">
                            ${business.amenities.slice(0, 6).map(amenity => `<span style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px;">${amenity}</span>`).join('')}
                            ${business.amenities.length > 6 ? `<span style="color: #6b7280;">+${business.amenities.length - 6} more</span>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="business-actions">
                        <button class="action-btn rate-btn" onclick="event.stopPropagation(); openRatingModal('${business.id}')">
                            Rate Restroom
                        </button>
                        <button class="action-btn directions-btn" onclick="event.stopPropagation(); getDirections(${business.lat}, ${business.lng})">
                            Directions
                        </button>
                    </div>
                    
                    <div class="business-owner-cta">
                        <p>Business Owner?</p>
                        <button onclick="event.stopPropagation(); openBusinessOwnerSignup()">Claim This Listing</button>
                    </div>
                </div>
            `).join('');
        }

        // Add markers to map
        function addMarkersToMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (businesses.length === 0) return;

            businesses.forEach(business => {
                // Use different icons for different business types
                let iconColor = '#3b82f6';
                let iconSymbol = 'üìç';
                
                switch (business.category) {
                    case 'truck_stop':
                        iconColor = '#d97706';
                        iconSymbol = 'üöõ';
                        break;
                    case 'rest_area':
                        iconColor = '#059669';
                        iconSymbol = 'üõ£Ô∏è';
                        break;
                    case 'fuel':
                        iconColor = '#dc2626';
                        iconSymbol = '‚õΩ';
                        break;
                    case 'fast_food':
                        iconColor = '#f59e0b';
                        iconSymbol = 'üçî';
                        break;
                    case 'restaurant':
                        iconColor = '#8b5cf6';
                        iconSymbol = 'üçΩÔ∏è';
                        break;
                    case 'cafe':
                        iconColor = '#6b7280';
                        iconSymbol = '‚òï';
                        break;
                    case 'hotel':
                        iconColor = '#10b981';
                        iconSymbol = 'üè®';
                        break;
                    case 'supermarket':
                    case 'shopping':
                        iconColor = '#f97316';
                        iconSymbol = 'üõí';
                        break;
                }

                const marker = L.marker([business.lat, business.lng])
                    .addTo(map)
                    .bindPopup(`
                        <div style="text-align: center;">
                            <h3>${business.name}</h3>
                            <p>${business.address}</p>
                            <p><strong>${business.type}</strong></p>
                            ${business.brand ? `<p style="color: #6b7280;">${business.brand}</p>` : ''}
                            <p>‚≠ê ${business.rating.overall}/10 (${business.rating.reviewCount} reviews)</p>
                            <p style="color: #059669;">üöª Has Restrooms</p>
                            <button onclick="getDirections(${business.lat}, ${business.lng})" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-top: 0.5rem;">Get Directions</button>
                        </div>
                    `);
                
                markers.push(marker);
            });

            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Update results count
        function updateResultsCount() {
            const count = businesses.length;
            const categories = [...new Set(businesses.map(b => b.type))];
            
            let countText = count === 0 ? 'No results found' : 
                           count === 1 ? '1 business found' : 
                           `${count} businesses found`;
            
            if (categories.length > 1) {
                countText += ` (${categories.length} categories)`;
            } else if (categories.length === 1) {
                countText += ` (${categories[0]})`;
            }
            
            document.getElementById('resultsCount').textContent = countText;
        }

        // Handle search errors
        function handleSearchError(error) {
            let errorMessage = 'Unable to search businesses. ';
            
            if (error.name === 'AbortError') {
                errorMessage += 'Search timed out. Please try a more specific search term.';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage += 'Network connection issue. Please check your internet connection.';
            } else {
                errorMessage += 'Please try again or use a different search term.';
            }

            document.getElementById('businessGrid').innerHTML = `<div class="error">${errorMessage}</div>`;
            document.getElementById('resultsCount').textContent = 'Search failed';
        }

        // Enable location
        function enableLocation() {
            const btn = document.getElementById('locationBtn');
            btn.disabled = true;
            btn.textContent = 'üìç Getting location...';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        if (window.userMarker) {
                            map.removeLayer(window.userMarker);
                        }
                        
                        window.userMarker = L.marker([userLocation.lat, userLocation.lng], {
                            icon: L.icon({
                                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiMzYjgyZjYiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMyIgZmlsbD0id2hpdGUiLz4KPC9zdmc+',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map).bindPopup('Your location');
                        
                        map.setView([userLocation.lat, userLocation.lng], 12);
                        
                        btn.textContent = 'üìç Location enabled';
                        btn.style.background = '#10b981';
                        
                        // Automatically search for nearby businesses
                        const parsedQuery = { businessName: '', location: '', zipCode: '', original: '' };
                        searchAllBusinesses(parsedQuery, userLocation.lat, userLocation.lng, currentCategory);
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        btn.disabled = false;
                        btn.textContent = 'üìç Enable Location';
                        showError('Unable to get your location. Please check your browser settings.');
                    }
                );
            } else {
                btn.disabled = false;
                btn.textContent = 'üìç Enable Location';
                showError('Geolocation is not supported by this browser.');
            }
        }

        // Filter by category
        function filterByCategory(category) {
            currentCategory = category;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const query = document.getElementById('searchInput').value.trim();
            if (query || userLocation) {
                const parsedQuery = parseComprehensiveQuery(query);
                searchAllBusinesses(parsedQuery, userLocation?.lat, userLocation?.lng, category);
            }
        }

        // Switch view
        function switchView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const container = document.getElementById('contentContainer');
            const mapContainer = document.getElementById('mapContainer');
            const businessGrid = document.getElementById('businessGrid');
            
            switch(view) {
                case 'split':
                    container.style.flexDirection = 'row';
                    mapContainer.style.display = 'block';
                    businessGrid.style.display = 'block';
                    break;
                case 'map':
                    container.style.flexDirection = 'row';
                    mapContainer.style.display = 'block';
                    businessGrid.style.display = 'none';
                    break;
                case 'list':
                    container.style.flexDirection = 'row';
                    mapContainer.style.display = 'none';
                    businessGrid.style.display = 'block';
                    break;
            }
            
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 100);
        }

        // Get directions
        function getDirections(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // Help system
        function toggleHelp() {
            helpMode = !helpMode;
            const btn = document.querySelector('.help-btn');
            if (helpMode) {
                btn.style.background = '#fbbf24';
                btn.style.color = '#1f2937';
                showSuccess('Help mode enabled! Hover over elements for tips.');
            } else {
                btn.style.background = 'rgba(255,255,255,0.2)';
                btn.style.color = 'white';
                hideTooltip();
            }
        }

        function showTooltip(element, text) {
            if (!helpMode) return;
            
            const tooltip = document.getElementById('helpTooltip');
            tooltip.textContent = text;
            tooltip.classList.add('show');
            
            const rect = element.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - 40) + 'px';
        }

        function hideTooltip() {
            const tooltip = document.getElementById('helpTooltip');
            tooltip.classList.remove('show');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openLoginModal() {
            openModal('loginModal');
        }

        function openSignupModal() {
            showSuccess('Sign up feature coming soon! Contact us for early access.');
        }

        // Handle login
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                currentUser = { username, isAdmin: true };
                closeModal('loginModal');
                openModal('adminModal');
                showSuccess('Welcome, Admin!');
            } else {
                showError('Invalid credentials. Please try again.');
            }
        }

        // Show admin section
        function showAdminSection(section) {
            const content = document.getElementById('adminSectionContent');
            
            switch(section) {
                case 'users':
                    content.innerHTML = `
                        <h3>User Management</h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <p><strong>Total Users:</strong> 2,847</p>
                            <p><strong>Active Today:</strong> 189</p>
                            <p><strong>New This Week:</strong> 43</p>
                            <p><strong>Reviewers:</strong> 1,234</p>
                        </div>
                    `;
                    break;
                case 'businesses':
                    content.innerHTML = `
                        <h3>Business Management</h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <p><strong>Total Businesses:</strong> ${businesses.length}</p>
                            <p><strong>Categories:</strong> ${[...new Set(businesses.map(b => b.type))].length}</p>
                            <p><strong>Verified:</strong> ${Math.floor(businesses.length * 0.85)}</p>
                            <p><strong>Pending Verification:</strong> ${Math.floor(businesses.length * 0.15)}</p>
                        </div>
                    `;
                    break;
                case 'reviews':
                    content.innerHTML = `
                        <h3>Review Moderation</h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <p><strong>Total Reviews:</strong> 8,291</p>
                            <p><strong>Pending Moderation:</strong> 23</p>
                            <p><strong>Flagged Reviews:</strong> 7</p>
                            <p><strong>Average Rating:</strong> 7.8/10</p>
                        </div>
                    `;
                    break;
                case 'analytics':
                    content.innerHTML = `
                        <h3>Analytics Dashboard</h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <p><strong>Daily Searches:</strong> 1,847</p>
                            <p><strong>Popular Categories:</strong> Fast Food (32%), Gas Stations (28%), Restaurants (18%)</p>
                            <p><strong>Top States:</strong> California, Texas, Florida, New York</p>
                            <p><strong>Mobile Users:</strong> 78%</p>
                        </div>
                    `;
                    break;
            }
        }

        // Placeholder functions
        function openBusinessOwnerSignup() {
            showSuccess('Business owner signup feature coming soon! Contact us for early access.');
        }

        function openRatingModal(businessId) {
            showSuccess('Rating feature coming soon! Thank you for your interest in helping the community.');
        }

        function openBusinessDetails(businessId) {
            const business = businesses.find(b => b.id === businessId);
            if (business) {
                showSuccess(`Viewing details for ${business.name}. Full details page coming soon!`);
            }
        }

        // Utility functions
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '160px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '3000';
            errorDiv.style.maxWidth = '400px';
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '160px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '3000';
            successDiv.style.maxWidth = '400px';
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });

        // Add help tooltips
        document.addEventListener('mouseover', function(event) {
            if (!helpMode) return;
            
            const element = event.target;
            let helpText = '';
            
            if (element.classList.contains('search-input')) {
                helpText = 'Search for any business name, city, state, or ZIP code';
            } else if (element.classList.contains('location-btn')) {
                helpText = 'Enable GPS to find businesses near your current location';
            } else if (element.classList.contains('category-btn')) {
                helpText = 'Filter results by business type';
            } else if (element.classList.contains('rate-btn')) {
                helpText = 'Rate the restroom cleanliness, safety, and accessibility';
            } else if (element.classList.contains('directions-btn')) {
                helpText = 'Get turn-by-turn directions to this business';
            }
            
            if (helpText) {
                showTooltip(element, helpText);
            }
        });

        document.addEventListener('mouseout', function(event) {
            if (helpMode && event.target.classList.contains('search-input', 'location-btn', 'category-btn', 'rate-btn', 'directions-btn')) {
                hideTooltip();
            }
        });
    </script>
</body>
</html>

